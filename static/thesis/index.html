<!DOCTYPE html>
<html lang="bg">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title>Разработване на он-лайн информационна система за резервация на места в пътническия железопътен транспорт</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
/*
  pygmentize filter
*/
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f4f4f4; }
.highlight .c { color: #008800; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #AA22FF; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #008800; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #008800 } /* Comment.Preproc */
.highlight .c1 { color: #008800; font-style: italic } /* Comment.Single */
.highlight .cs { color: #008800; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #AA22FF; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #AA22FF; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #AA22FF; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #AA22FF } /* Keyword.Pseudo */
.highlight .kr { color: #AA22FF; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #00BB00; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BB4444 } /* Literal.String */
.highlight .na { color: #BB4444 } /* Name.Attribute */
.highlight .nb { color: #AA22FF } /* Name.Builtin */
.highlight .nc { color: #0000FF } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #00A000 } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #B8860B } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BB4444 } /* Literal.String.Backtick */
.highlight .sc { color: #BB4444 } /* Literal.String.Char */
.highlight .sd { color: #BB4444; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BB4444 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BB4444 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BB4444 } /* Literal.String.Single */
.highlight .ss { color: #B8860B } /* Literal.String.Symbol */
.highlight .bp { color: #AA22FF } /* Name.Builtin.Pseudo */
.highlight .vc { color: #B8860B } /* Name.Variable.Class */
.highlight .vg { color: #B8860B } /* Name.Variable.Global */
.highlight .vi { color: #B8860B } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */

</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-115818-51']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</head>
<body class="article">
<div id="header">
<h1>Разработване на он-лайн информационна система за резервация на места в пътническия железопътен транспорт</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="preface">Увод</h2>
<div class="sectionbody">
<div class="paragraph"><p>Използването на пътнически железопътен транспортни в Европейският съюз нараства с около един процент всяка година <a href="#eurostat">[eurostat]</a>. Търсенето на този вид транспорт от клиентите се обуславя от неговото удобство, предсказуемост и не на последно място цена. За съжаление пътническият железопътният транспорт в България посреща тази тенденция с неадекватни мерки, които според официалната статистика от Националния статистически институт, води и до намаляване на превозите на пътници всяка година <strong>фиг. 1.1</strong> <a href="#nsi">[nsi]</a>.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/nsi.svg" alt="Превозени пътници от железопътен транспорт" width="640">
</div>
<div class="title">Фигура 1. Превозени пътници от железопътен транспорт по години</div>
</div>
<div class="paragraph"><p>Причините за спадът на пътникопотока са много и не винаги икономически. Голяма част от загубите на БДЖ за в следствие от недалновидна и нецеленасочена политика по управление на компанията, която все още се държи като монополист в един отворен пазар. Тази заблуда за монополно положение все още се поддържа жива от социалните пакети за пътуване: билети за възрастни граждани и учащи се, преференциалните билети за държавни служители и др. В тази ниша БДЖ наистина има традиционно силно присъствие. За съжаление тази дейност най-често е губеща дори в случаите, когато е субсидирана от държавата. Във средният и високият потребителски сегмент, компанията отстъпва на автобусните превози и личните автомобили. Причината е че тези два сегмента не са толкова чувствителни към цената на билета а определящи за техния избор са по-скоро гъвкавостта, комфорта и удобството. Удобството не се изразява само в удобството на самото пътуване а в цялостния процес на взаимодействие с компанията.</p></div>
<div class="paragraph"><p>Първата стъпка от това взаимодействие е изборът и закупуването на билет за превоз. Това е най-важната стъпка в която клиентът трябва да бъде убеден да използва дадена услуга. Последващите стъпки от превозния процес са не по-малко важни но точно тук инвестицията се капитализира в конкретна покупка.</p></div>
<div class="paragraph"><p>БДЖ направи опит през 2011 година да въведе хибридна система за резервация на билети чрез международните бюра "Рила"<a href="#dnevnik">[dnevnik]</a>, но целият процес по-скоро затрудняваше клиента, отколкото да му помага. Реализацията на он-лайн система за продажба на електронни билети би дало стратегическо предимство на БДЖ в сухопътните пътнически превози. Компанията, за разлика от по-малките транспортни фирми, има необходимия обем и разнообразие на транспортни услуги, които да съставят притегателното ядро за потенциални клиенти.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-1">Анализ на европейските практики в онлайн продажбата на електронни билети за железопътен транспорт</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/2000-situation_large.png" alt=""Железопътна мрежа на Европа">
</div>
<div class="title">Фигура 2. Железопътна мрежа на Европа 2000г. <a href="#hgise">[hgise]</a></div>
</div>
<div class="paragraph"><p>Болшинството от европейските железопътни оператори предлагат на клиентите си възможности за закупуване и резервация на билети, он-лайн:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Таблица 1. Он-лайн присъствие на основните железопътните оператори в Европа</caption>
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Държава </th>
<th class="tableblock halign-left valign-top" >Оператор   </th>
<th class="tableblock halign-left valign-top" >Сайт             </th>
<th class="tableblock halign-left valign-top" >Онлайн разписание  </th>
<th class="tableblock halign-left valign-top" >Онлайн продажба на билети</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Австрия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ÖBB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.oebb.at/">http://www.oebb.at/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Белгия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">NMBS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.b-rail.be/">http://www.b-rail.be/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">България</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">БДЖ</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.bdz.bg/">http://www.bdz.bg/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Германия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Deutsche Bahn</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.bahn.com/">http://www.bahn.com/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Гърция</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OSE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://trainose.gr/">http://trainose.gr/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Дания</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DSB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.dsb.dk/">http://www.dsb.dk/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Ирландия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CIÉ</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.irishrail.ie/">http://www.irishrail.ie/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Испания</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Renfe</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.renfe.com/">http://www.renfe.com/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Италия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Trenitalia</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.trenitalia.com/">http://www.trenitalia.com/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Люксембург</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CFL</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.cfl.lu/">http://www.cfl.lu/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Норвегия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">NSB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.nsb.no/">http://www.nsb.no/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Полша</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PKP</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://rozklad-pkp.pl/">http://rozklad-pkp.pl/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Португалия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CP</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.cp.pt/">http://www.cp.pt/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Румъния</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CFR</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.cfr.ro/">http://www.cfr.ro/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Словакия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ZSSK</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.zssk.sk/">http://www.zssk.sk/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Словения</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SŽ</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.slo-zeleznice.si/">http://www.slo-zeleznice.si/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Сърбия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ŽS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.serbianrailways.com/">http://www.serbianrailways.com/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Финландия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">VR</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.vr.fi/">http://www.vr.fi/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Франция</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SNCF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.sncf.com/">http://www.sncf.com/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Унгария</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MÁV-START</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.mav-start.hu/">http://www.mav-start.hu/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Холандия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">NS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.ns.nl/">http://www.ns.nl/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Хърватска</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">HZ</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.hznet.hr/">http://www.hznet.hr/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Черна гора</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ZCG</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.zcg-prevoz.me/">http://www.zcg-prevoz.me/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">не</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Чехия</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Czech Railways</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.cd.cz/">http://www.cd.cz/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Щвейцария</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SBB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.sbb.ch">http://www.sbb.ch</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Швеция</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SJ</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><a href="http://www.sj.se/">http://www.sj.se/</a></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">да</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="______">Онлайн портали на европейски железопътни оператори</h3>
<div class="paragraph"><p>Следва кратко представяне на всеки един от сайтовете:</p></div>
<div class="sect3">
<h4 id="_">Австрия</h4>
<div class="paragraph"><p>Сайта на ÖBB предлага следните възможности за он-лайн закупуване на билети:
- електронни билети, които се разпечатват на принтер;
- електронни билети с електронни карти;
- електронни билети с доставка по пощата;
- SMS билети при които цената се включва в сметката за мобилен телефон или се заплаща на специални терминали на гарите;</p></div>
<div class="paragraph"><p>Освен различните видове билети, сайта предлага закупуването на карти за отстъпка и различни пакетни оферти за почивки и културни събития.</p></div>
</div>
<div class="sect3">
<h4 id="__2">Белгия</h4>
<div class="paragraph"><p>Порталът предлага електронни билети за печат и такива, които се зареждат в електронни карти. Освен билети от сайта могат да бъдат закупени и ограничен брой туристически пакети.</p></div>
</div>
<div class="sect3">
<h4 id="__3">България</h4>
<div class="paragraph"><p>Сайтът на БДЖ към момента не предлага он-лайн продажба на билети. Разписанието дава информация за някой цени на билети а информацията в него е актуална.</p></div>
</div>
<div class="sect3">
<h4 id="__4">Германия</h4>
<div class="paragraph"><p>Deutsche Bahn предлагат електронни билети за разпечатване, MMS билети и доставка на билети по пощата. Сайта предлага също така оферти за хотели и кола под наем. Също така се предлага голямо разнообразие от карти за намаление и пътуване до международни дестинации.</p></div>
</div>
<div class="sect3">
<h4 id="__5">Гърция</h4>
<div class="paragraph"><p>Порталът на Гърция предлага резервиране и заплащане на билети онлайн. За съжаление голяма част от сайта е само на гръцки език, което го прави неудобен за чужденци.</p></div>
</div>
<div class="sect3">
<h4 id="__6">Дания</h4>
<div class="paragraph"><p>Датският портал, предлага възможност за използване на различни видове транспорт при избор на маршрут. Интересна възможност е показването на индекса на вредни емисии на всяко пътуване и сравнението при пътуване с автомобил. За съжаление части от сайта са само на датски и въпреки че има ръководство за използване на английски език, използването е затруднено. Закупените електронни билети се разпечатват на принтер и се предоставят за проверка в превозното средство.</p></div>
</div>
<div class="sect3">
<h4 id="__7">Ирландия</h4>
<div class="paragraph"><p>В Ирландия се предлагат електронни билети за печат, които в някой случаи са по-евтини от редовните билети, издавани на каса.</p></div>
</div>
<div class="sect3">
<h4 id="__8">Испания</h4>
<div class="paragraph"><p>Сайта на Renfe е изцяло на испански. Сайта предлага закупуването на електронни билети он-лайн.</p></div>
</div>
<div class="sect3">
<h4 id="__9">Италия</h4>
<div class="paragraph"><p>Продават се електронни билети и свързани с пътуване пакетни оферти. Електронните билети се разпечатват на принтер.</p></div>
</div>
<div class="sect3">
<h4 id="__10">Люксембург</h4>
<div class="paragraph"><p>Продават се електронни билети за пътуване до съседни държави.</p></div>
</div>
<div class="sect3">
<h4 id="__11">Норвегия</h4>
<div class="paragraph"><p>Билети чрез смартфони. Ако изчакването при прехвърляне надхвърля 30 минути, клиентът получава компенсация. Срещу доплащане се предлагат места със електрическо захранване. Възможност за резервация на хотели. Закупените билети се използват през приложението за смартфон или се получават от автомати разположени на гарите.</p></div>
</div>
<div class="sect3">
<h4 id="__12">Полша</h4>
<div class="paragraph"><p>В Полша се предлага само он-лайн резервация на билети чрез сайта <a href="http://www.polrail.com/">http://www.polrail.com/</a>, който се явява фирма посредник.</p></div>
</div>
<div class="sect3">
<h4 id="__13">Португалия</h4>
<div class="paragraph"><p>В Португалия, могат да бъдат закупени он-лайн електронни билети за разпечатване на принтер. Интересен вариант е и закупуването на билети от банкомати.</p></div>
</div>
<div class="sect3">
<h4 id="__14">Румъния</h4>
<div class="paragraph"><p>В Румъния, он-лайн билети могат да бъдат закупени чрез портала <a href="http://www.cfrcalatori.ro/">http://www.cfrcalatori.ro/</a>. За закупените по този начин билети, клиентите получават отстъпка от 5% от стойността на билета.</p></div>
</div>
<div class="sect3">
<h4 id="__15">Словакия</h4>
<div class="paragraph"><p>Има възможност за закупуване на он-лайн билети.</p></div>
</div>
<div class="sect3">
<h4 id="__16">Словения</h4>
<div class="paragraph"><p>На клиентите е предложено само разписание без възможност за он-лайн поръчка или резервация на билети.</p></div>
</div>
<div class="sect3">
<h4 id="__17">Сърбия</h4>
<div class="paragraph"><p>В Сърбия електронни билети могат да бъдат закупени от сайта <a href="http://w3.srbrail.rs/eticketing/">http://w3.srbrail.rs/eticketing/</a> но само за влакове по определени направления. Електронните билети се разпечатват на принтер и служат като легитимен превозен документ.</p></div>
</div>
<div class="sect3">
<h4 id="__18">Финландия</h4>
<div class="paragraph"><p>Електронните билети във Финландия могат да бъдат разпечатани или получени като SMS.</p></div>
</div>
<div class="sect3">
<h4 id="__19">Франция</h4>
<div class="paragraph"><p>Във Франция, он-лайн билети се продават през портала <a href="http://www.voyages-sncf.com/">http://www.voyages-sncf.com/</a>. Билетите могат да се разпечатват на принтер или да бъдат доставени по пощата.</p></div>
</div>
<div class="sect3">
<h4 id="__20">Унгария</h4>
<div class="paragraph"><p>Предлага се само онлайн разписание и няколко туристически оферти.</p></div>
</div>
<div class="sect3">
<h4 id="__21">Холандия</h4>
<div class="paragraph"><p>Предлагат се електронни билети за разпечатване</p></div>
</div>
<div class="sect3">
<h4 id="__22">Хърватска</h4>
<div class="paragraph"><p>В Хърватска не се предлага он-лайн продажба на билети.</p></div>
</div>
<div class="sect3">
<h4 id="__">Черна гора</h4>
<div class="paragraph"><p>На сайта на железопътни превози - Черна гора може да се открие базова информация за нормативната уредба в страната и PDF файлове с маршрутите. Он-лайн билети не се предлагат.</p></div>
</div>
<div class="sect3">
<h4 id="__23">Чехия</h4>
<div class="paragraph"><p>Предлагат се няколко вида електронни билети, които могат да бъдат разпечатани.</p></div>
</div>
<div class="sect3">
<h4 id="__24">Швейцария</h4>
<div class="paragraph"><p>В Швейцария се предлагат електронни билети за печат и мобилни билети за смартфони.</p></div>
</div>
<div class="sect3">
<h4 id="__25">Швеция</h4>
<div class="paragraph"><p>Предлага се он-лайн закупуване на електронни билети.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_____">Изисквания за он-лайн системата</h3>
<div class="paragraph"><p>След анализ на данните от порталите на националните железопътни оператори се налага изводът че една модерна система трябва да притежава всички или поне по-голямата част от следните характеристики:</p></div>
<div class="sect3">
<h4 id="__26">Многоезичност</h4>
<div class="paragraph"><p>Немалък процент от потребителите на системи за онлайн продажба на билети са чужденци, за които в някой случаи системата е единствения достъп до транспортния пазар в страната. Поддръжката на съдържание на няколко езика е времеемко и ресурсоемко като освен това намалява гъвкавостта на информацията. Затова изборът на поддържани езици трябва да се направи на база оценка на потенциалния пазар. Почти всички портали поддържат версия на английски език, който се е наложил де факто като стандарт в Интернет</p></div>
</div>
<div class="sect3">
<h4 id="___2">Мобилна версия</h4>
<div class="paragraph"><p>Използването на мобилни устройства бележи ръст в последните 5 години. Тази тенденция е нормална като се има предвид удобството и преносимостта на този тип устройства. Благодарение на широкото им разпространение в тази ниша се оформя все по-голям пазар. Това налага поддръжката на мобилни платформи от системата. Това може да стане по няколко различни начина.</p></div>
<div class="ulist"><ul>
<li>
<p>
основен сайт с адаптивен дизайн който да поддържа както мобилни, така и десктоп устройства. Предимствата на този метод е че се разработва и поддържа само един сайт което чувствително намалява разходите и сроковете за изработка и поддръжка. Недостатъците са че хибридния модел носи със себе си доста ограничения, които макар че в повечето случаи не са непреодолими, затрудняват разработката.
</p>
</li>
<li>
<p>
отделна версия за мобилни устройства. Този вариант дава свобода в разработката на двата отделни сайта, но прави поддръжката по-сложна.
</p>
</li>
<li>
<p>
мобилни приложения. Плюсовете на този подход са че мобилните приложения обикновено са по-бързи, прехвърлят по-малко количество данни през преносната мрежа и могат да предоставят функционалност, недостъпна през WEB браузъра. Недостатъците са фрагментираната екосистема от мобилни платформи, за да е ефективна подобна стратегия трябва да се разработят приложения поне за iOS и Android платформите, които след това трябва и да се поддържат.
</p>
</li>
<li>
<p>
външни разработчици. Тъй като софтуерните разработки, рядко са приоритет на железопътните оператори, задачата по разработка на мобилна версия на системата може да се отстъпи на трети лица. Най-добрият начин за това е като се предостави програмен интерфейс към системата т.нар. API, който да може да се ползва свободно от разработчици, който да разработят собствен програмен продукт на база системата.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="____">Разнообразни методи за плащане</h4>
<div class="paragraph"><p>Успешното плащане е една от основните цели на системата, затова поддръжката на разнообразни кредитни и дебитни карти е важно за използваемостта на системата. В България възможните варианти са:</p></div>
<div class="ulist"><ul>
<li>
<p>
ePay (<a href="http://www.epay.bg">http://www.epay.bg</a>)- поддържат болшинството от дебитни карти издавани в страната, изискват потребителя да има регистрация;
</p>
</li>
<li>
<p>
eBg (<a href="http://www.ebg.bg/">http://www.ebg.bg/</a>) - поддържат плащане с български дебитни карти и виртуални кредитни карти;
</p>
</li>
<li>
<p>
EasyPay (<a href="http://www.easypay.bg/">http://www.easypay.bg/</a>) - комбинирано онлайн задължаване и офлайн заплащане. Популярен вариант за потребители без банкови карти;
</p>
</li>
<li>
<p>
виртуален POS - предлага се от няколко банки, приемат се плащания с международни кредитни карти, обикновено не се изисква регистрация на потребителя;
</p>
</li>
<li>
<p>
банков превод - предлага се от всички банки;
</p>
</li>
<li>
<p>
наложен платеж - широко използван метод за плащане в България, предлага се от куриерските фирми, има приложение само при доставка на билети;
</p>
</li>
<li>
<p>
PayPal (<a href="http://www.paypal.com">http://www.paypal.com</a>) - международен оператор на картови разплащания, удобен за използване от клиентите;
</p>
</li>
<li>
<p>
SMS плащания - имат фиксирана цена за обработка на транзакция така че не са ефективни за много малки суми. Изискват подписване на договори със всички оператори и разработка на обща система с тях. Удобни за потребителите, тъй като изискват само мобилен телефон без претенции към операционната му система;
</p>
</li>
</ul></div>
<div class="paragraph"><p>От този списък трябва да се избере не само един оператор а всички рентабилни, тъй като различните потребители разполагат с различни платежни средства а и имат различни предпочитания към използваните услуги.</p></div>
</div>
<div class="sect3">
<h4 id="___3">Превозни документи</h4>
<div class="paragraph"><p>Създаването на валидируем превозен документ е една от основните цели на системата. В практиката се използват следните варианти на документи:</p></div>
<div class="ulist"><ul>
<li>
<p>
електронен билет - един от най-лесните за издаване документи, разчита на разпечатване на генерирана от системата бланка, която включва информация за пътуването, цената на билета и служебна информация, която да удостовери валидността на документа. Най-често за проверка се използват баркодове, разпечатани на билета, които се проверяват от кондуктора. Също така могат да се използват QR кодове или прост идентификационен номер който да се въведе ръчно. За да се използва метода, кондукторите трябва да са екипирани с устройства с памет баркод четци за да могат да проверят дали билетът е уникален, издаден за този влак и тази дата на пътуван. Информацията в устройствата може да се синхронизира след приключване на резервационния период и преди потеглянето на влака.
</p>
</li>
<li>
<p>
мобилен билет - мобилен билет се реализира чрез специално приложение за смартфон, което в се явява приемник на данните за билета. При този вариант се избягва хартиения носител а проверката се извършва най-често чрез QR-код.
</p>
</li>
<li>
<p>
SMS билет - клиента получава уникален код от системата изпратен под формата на SMS, кодът се проверява ръчно от кондуктора;
</p>
</li>
<li>
<p>
електронни карти - обикновено магнитна картата, която идентифицира уникално клиента. При покупка на билет, системата указва че с картата може да се пътува за определена дата по дадено направление и тази информация се проверява от кондуктора;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_______">Обвръзка с други услуги и видове транспорт</h4>
<div class="paragraph"><p>Нуждата от транспортна услуга рядко е самоцелна и много често е част от по-широки намерения на клиента. Предлагането на допълнителни услуги като резервация на хотели и наемане на автомобил както и обвръзката с останалите видове транспорт създава голяма добавена стойност към системата. Цялостното обслужване на клиента създава в него доверие а също така може да доведе до по-ниска обща цена на услугата и по-висок оборот на оператора. Този похват се използва особено широко при въздушните превозвачи но няма причина да не е приложим и при сухопътните превози.</p></div>
</div>
<div class="sect3">
<h4 id="_______2">Достъп до пълна и актуална информация</h4>
<div class="paragraph"><p>Колкото и фундаментално да изглежда това условие, все пак си заслужава да бъде спомената, защото често бива забравено или оставено на заден план. Потребителят предпочита да е информиран за всички детайли, особено ако ще използва дадена услуга за първи път. За целта е необходимо да има достъп до пълно и точно разписание както и всички варинати за билети които може да получи. Добре е да се представят плюсовете на всеки вид билет за да може, клиента да направи информиран избор.</p></div>
</div>
<div class="sect3">
<h4 id="___4">Бонус програми</h4>
<div class="paragraph"><p>Част от операторите предлагат намаление на цената на билета ако е закупен онлайн. Тази разлика се обуславя от по-ниските разходи за продажбата но не трябва да е единствения стимул за клиента. Бонус програми, натрупани километри пътуване, намаления за чести пътувания са само някой от вариантите за създаване на лоялни клиенти.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-2">Проектиране и изграждане на система за он-лайн продажба на електронни билети</h2>
<div class="sectionbody">
<div class="paragraph"><p>Системата се състои от четири функционални модула. Потребителският и административен модул са WEB базирани реализирани на езикът за програмиране PHP, като е използвана и библиотеката CodeIgniter. Системата използва WEB сървър Apache2 но би могла да работи и с nginx, lighthttpd или друг сървър, който поддържа mod_php или php-cgi. Целите, които си поставя системата е да реализира базовата функционалност необходима за успешно обслужване на клиенти. Разбира се една такава система може да се усложнява и развива почти безгранично в зависимост от конкретната обстановка и плановете на мениджмънта.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/func_all.svg" alt="Схема на функционалните модули на системата" width="400">
</div>
<div class="title">Фигура 3. Схема на функционалните модули на системата</div>
</div>
<div class="paragraph"><p>Системата е изготвена от четири атомарни хетерогенни модула, които комуникират по утвърдени комуникационни протоколи избрани на база рентабилност. Модулът <strong>razpisanie</strong> е реализиран като отделен HTTP сървър на езикът <strong>Go</strong>. Комуникацията с основния сайт се извършва посредством HTTP протокол като част от данните се предават чрез JSON протокол. Комуникацията на сайта с базата данни се осъществява чрез UNIX socket или TCP socket в зависимост от настройките.</p></div>
<div class="paragraph"><p>Първата стъпка в разработката е проектиране на структурата на базата данни.</p></div>
<div class="sect2">
<h3 id="chapter-2-1">База данни</h3>
<div class="paragraph"><p>Сайта използва MySQL база данни за съхранение и обработка на данните. Изборът на MySQL е обусловен от широката употреба на тази СУБД и сравнително лесното ѝ използване както от професионалисти така и от начинаещи. Системата позволява миграция и към друга СУБД, примерно PostgreSQL със сравнително малки модификации.</p></div>
<div class="paragraph"><p>Данните са разпределена в следните таблици:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/database.svg" alt="Схема база данни" width="640">
</div>
<div class="title">Фигура 4. Схема на базата данни</div>
</div>
<div class="paragraph"><p>Следва кратко описание на структурата на всяка таблица:</p></div>
<div class="sect3">
<h4 id="_calendar_prices">calendar_prices</h4>
<div class="paragraph"><p>Списък на календарните влакове.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>train_id</strong> - идентификатор на превозно средство;
</p>
</li>
<li>
<p>
<strong>day_of_week</strong> - ден от седмицата в PHP формат (1 - понеделник, 7 - неделя);
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на записа;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на добавяне на записа
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_ci_sessions">ci_sessions</h4>
<div class="paragraph"><p>Таблица за съхранение на потребителските сесии.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>session_id</strong> - идентификатор на сесията;
</p>
</li>
<li>
<p>
<strong>ip_address</strong> - IP адрес на потребителя;
</p>
</li>
<li>
<p>
<strong>user_agent</strong> - User-Agent на браузъра;
</p>
</li>
<li>
<p>
<strong>last_activity</strong> - последна активност на потребителя;
</p>
</li>
<li>
<p>
<strong>user_data</strong> - потребителски данни;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_distance_prices">distance_prices</h4>
<div class="paragraph"><p>Тарифи за разстояния.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>train_type_id</strong> - идентификатор на типа превозно средство;
</p>
</li>
<li>
<p>
<strong>ticket_type_id</strong> - идентификатор на типа тарифа;
</p>
</li>
<li>
<p>
<strong>lfrom</strong> - долна граница на интервала по разстояние;
</p>
</li>
<li>
<p>
<strong>lto</strong> - горна граница на интервала по разстояние;
</p>
</li>
<li>
<p>
<strong>klass1</strong> - цена за билет клас 1;
</p>
</li>
<li>
<p>
<strong>klass2</strong> - цена за билет клас 2;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_order_status">order_status</h4>
<div class="paragraph"><p>Списък с възможни статуси на поръчка.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на статуса;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_orders">orders</h4>
<div class="paragraph"><p>Клиентски поръчки и резервации.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>user_id</strong> - идентификатор на потребител;
</p>
</li>
<li>
<p>
<strong>route_detail_id</strong> - идентификатор на сегмент от маршрут;
</p>
</li>
<li>
<p>
<strong>train_id</strong> - идентификатор на превозно средство;
</p>
</li>
<li>
<p>
<strong>ticket_type_id</strong> - идентификатор на тарифа;
</p>
</li>
<li>
<p>
<strong>date</strong> - дата на пътуване;
</p>
</li>
<li>
<p>
<strong>quantity</strong> - количество билети;
</p>
</li>
<li>
<p>
<strong>price</strong> - единична цена;
</p>
</li>
<li>
<p>
<strong>from_station_id</strong> - идентификатор на начална гара;
</p>
</li>
<li>
<p>
<strong>to_station_id</strong> - идентификатор на крайна гара;
</p>
</li>
<li>
<p>
<strong>class</strong> - клас билет;
</p>
</li>
<li>
<p>
<strong>wagon</strong> - номер на вагон (0 ако е без резервация);
</p>
</li>
<li>
<p>
<strong>place_num</strong> - номер на запазено място (0 ако е без резервация);
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на поръчката;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на поръчване;
</p>
</li>
<li>
<p>
<strong>expires</strong> - дата и час на изтичане на резервацията;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_route">route</h4>
<div class="paragraph"><p>Изчислен маршрут между две гари.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>from_station_id</strong> - идентификатор на начална гара;
</p>
</li>
<li>
<p>
<strong>to_station_id</strong> - идентификатор на крайна гара;
</p>
</li>
<li>
<p>
<strong>distance</strong> - разстояние (в стотици метри);
</p>
</li>
<li>
<p>
<strong>departure_time</strong> - час на заминаване (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>arrival_time</strong> - час на пристигане  (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>transfers</strong> - брой прехвърляния по маршрута;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_route_detail">route_detail</h4>
<div class="paragraph"><p>Сегмент от изчислен маршрут.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>route_id</strong> - идентификатор на маршрут;
</p>
</li>
<li>
<p>
<strong>train_id</strong> - идентификатор на превозно средство;
</p>
</li>
<li>
<p>
<strong>from_station_id</strong> - идентификатор на начална гара;
</p>
</li>
<li>
<p>
<strong>to_station_id</strong> - идентификатор на крайна гара;
</p>
</li>
<li>
<p>
<strong>distance</strong> - разстояние (в стотици метри);
</p>
</li>
<li>
<p>
<strong>departure_time</strong> - час на заминаване (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>arrival_time</strong> - час на пристигане (в минути след 0:00 часа);
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_station">station</h4>
<div class="paragraph"><p>Списък гари.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на гарата;
</p>
</li>
<li>
<p>
<strong>latitude</strong> - географска ширина;
</p>
</li>
<li>
<p>
<strong>longitude</strong> - географска дължина;
</p>
</li>
<li>
<p>
<strong>sorder</strong> - ред на сортиране;
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на записа;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_ticket_type">ticket_type</h4>
<div class="paragraph"><p>Списък тарифи.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на тарифата;
</p>
</li>
<li>
<p>
<strong>sorder</strong> - ред на сортиране;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_train">train</h4>
<div class="paragraph"><p>Превозни средства.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на превозното средство;
</p>
</li>
<li>
<p>
<strong>train_type_id</strong> - тип на превозното средство;
</p>
</li>
<li>
<p>
<strong>from_station_id</strong> - идентификатор на начална гара;
</p>
</li>
<li>
<p>
<strong>to_station_id</strong> - идентификатор на крайна гара;
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на превозното средство;
</p>
</li>
<li>
<p>
<strong>departure_time</strong> - час на заминаване (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>arrival_time</strong> - час на пристигане (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_train_station">train_station</h4>
<div class="paragraph"><p>Точки от маршрута на влак.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>train_id</strong> - идентификатор на превозно средство;
</p>
</li>
<li>
<p>
<strong>station_id</strong> - идентификатор на гара;
</p>
</li>
<li>
<p>
<strong>travel_time</strong> - време за пътуване (в минути);
</p>
</li>
<li>
<p>
<strong>departure_time</strong> - час на заминаване (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>arrival_time</strong> - час на пристигане (в минути след 0:00 часа);
</p>
</li>
<li>
<p>
<strong>distance</strong> - разстояние (в стотици метра);
</p>
</li>
<li>
<p>
<strong>sorder</strong> - хронологичен ред;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_train_type">train_type</h4>
<div class="paragraph"><p>Списък на типове превозни средства.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - кратко име на типа;
</p>
</li>
<li>
<p>
<strong>long_name</strong> - описание на типа;
</p>
</li>
<li>
<p>
<strong>status</strong> - статус;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_train_wagon">train_wagon</h4>
<div class="paragraph"><p>Подвижен състав на превозните средства.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>date</strong> - дата на състава (0 ако е базов);
</p>
</li>
<li>
<p>
<strong>train_id</strong> - идентификатор на превозно средство;
</p>
</li>
<li>
<p>
<strong>wagon_type_id</strong> - идентификатор на тип вагон;
</p>
</li>
<li>
<p>
<strong>sorder</strong> - пореден номер;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_train_wagon_pricelist">train_wagon_pricelist</h4>
<div class="paragraph"><p>Конфигурации за комбинации влак/вагон/тарифа.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>is_calendar</strong> - календарен (0-не, 1-да);
</p>
</li>
<li>
<p>
<strong>train_type_id</strong> - идентификатор на тип превозно средство;
</p>
</li>
<li>
<p>
<strong>wagon_type_id</strong> - идентификатор на тип вагон;
</p>
</li>
<li>
<p>
<strong>ticket_type_id</strong> - идентификатор на тарифа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_user">user</h4>
<div class="paragraph"><p>Регистрирани потребители.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>email</strong> - e-mail адрес на потребителя;
</p>
</li>
<li>
<p>
<strong>password</strong> - парола в криптиран формат;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на потребителя;
</p>
</li>
<li>
<p>
<strong>phone</strong> - телефон на потребителя;
</p>
</li>
<li>
<p>
<strong>admin</strong> - администраторски права (0 -не, 100 - да);
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на профила;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_wagon_type">wagon_type</h4>
<div class="paragraph"><p>Видове вагони.</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>id</strong> - идентификатор;
</p>
</li>
<li>
<p>
<strong>name</strong> - име на вагона;
</p>
</li>
<li>
<p>
<strong>long_name</strong> - описание на вагона;
</p>
</li>
<li>
<p>
<strong>reservation</strong> - възможност за резервация на място (0-не, 1-да);
</p>
</li>
<li>
<p>
<strong>seats</strong> - брой места във вагона;
</p>
</li>
<li>
<p>
<strong>passenger</strong> - пътнически? (0-не, 1-да);
</p>
</li>
<li>
<p>
<strong>layout</strong> - схема на местата във вагона;
</p>
</li>
<li>
<p>
<strong>status</strong> - статус на вагона;
</p>
</li>
<li>
<p>
<strong>created</strong> - дата и час на създаване на записа;
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="chapter-2-2">Попълване на БД от изходните данни</h3>
<div class="paragraph"><p>Част от изходните данни са в електронен формат, което ги прави идеални кандидати за автоматичен импорт в системата.</p></div>
<div class="sect3">
<h4 id="chapter-2-2-1">Разписание</h4>
<div class="paragraph"><p>Файлът <strong>2010-TIMETABL.TXT</strong> съдържа информация за движението на всички влакове в текстов формат. Кодировката на файла е windows-1251, затова първо преобразуваме текста в utf-8 кодировка която е де-факто стандарт в модерните мултиезични системи. За целта използваме служебната програма <strong>iconv</strong>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$iconv -f cp1251 -t utf8 2010-TIMETABL.TXT &gt; timetable.txt</pre>
</div></div>
<div class="paragraph"><p>Използваме конзолен PHP скрипт за обработка на текста, като резултата от скрипта е SQL скрипт, който директно може да се изпълни на SQL сървъра:</p></div>
<div class="paragraph"><p>Скрипта обработва файла за разписание и генерира SQL скрипт от него:</p></div>
<div class="listingblock">
<div class="title">import.php</div>
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">Import</span> <span class="p">{</span>

  <span class="k">var</span> <span class="nv">$in_train</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$train</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">var</span> <span class="nv">$stations</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">var</span> <span class="nv">$trains</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">var</span> <span class="nv">$train_types</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="k">function</span> <span class="nf">do_import</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">die</span><span class="p">(</span><span class="s1">&#39;File &#39;</span><span class="o">.</span><span class="nv">$file_name</span><span class="o">.</span><span class="s1">&#39; not found!&#39;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$handle</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$handle</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">((</span><span class="nv">$buffer</span> <span class="o">=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$handle</span><span class="p">,</span> <span class="mi">4096</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processLine</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$handle</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&quot;Error: unexpected fgets() fail</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nb">fclose</span><span class="p">(</span><span class="nv">$handle</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">saveTrain</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//print_r($this-&gt;trains);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">processLine</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">trim</span><span class="p">(</span><span class="nv">$line</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">saveTrain</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
        <span class="c1">//echo &#39;header&#39;.$line.PHP_EOL;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">));</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;minutes2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;arrival_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;departure_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span><span class="nv">$line</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$station</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">getElement</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$array</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$index</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$array</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$index</span> <span class="o">===</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$array</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$array</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$index</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">timeToMinutes</span><span class="p">(</span><span class="nv">$time</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$time</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">list</span><span class="p">(</span><span class="nv">$min</span><span class="p">,</span> <span class="nv">$sec</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$time</span><span class="p">));</span>
      <span class="k">return</span> <span class="nv">$sec</span><span class="o">+</span><span class="p">(</span><span class="nv">$min</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">saveTrain</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$train</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;train_type&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getElement</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train_types</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
      <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$station</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$name</span> <span class="o">=</span> <span class="nb">mb_convert_case</span><span class="p">(</span><span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nx">MB_CASE_TITLE</span><span class="p">);</span>

      <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;station_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getElement</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stations</span><span class="p">,</span> <span class="nv">$name</span><span class="p">),</span>
        <span class="s1">&#39;time&#39;</span> <span class="o">=&gt;</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;minutes&#39;</span><span class="p">]</span><span class="o">?</span><span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;minutes&#39;</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;arrival_time&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timeToMinutes</span><span class="p">(</span><span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;arrival_time&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;departure_time&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timeToMinutes</span><span class="p">(</span><span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;departure_time&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;len&#39;</span> <span class="o">=&gt;</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trains</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$train</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">generateSQL</span><span class="p">(){</span>
    <span class="k">echo</span> <span class="s2">&quot;SET names utf8;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stations</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$station</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO station (id, name) VALUES (%d, &#39;%s&#39;);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$station</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">train_types</span> <span class="k">as</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$tt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO train_type (id, name) VALUES (%d, &#39;%s&#39;);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$tt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trains</span> <span class="k">as</span> <span class="nv">$train_id</span> <span class="o">=&gt;</span> <span class="nv">$train</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$from_id</span> <span class="o">=</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;station_id&#39;</span><span class="p">];</span>
      <span class="nv">$to_id</span> <span class="o">=</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][</span><span class="nb">count</span><span class="p">(</span><span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;station_id&#39;</span><span class="p">];</span>
      <span class="nv">$departure_time</span> <span class="o">=</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;departure_time&#39;</span><span class="p">];</span>
      <span class="nv">$arrival_time</span> <span class="o">=</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">][</span><span class="nb">count</span><span class="p">(</span><span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;arrival_time&#39;</span><span class="p">];</span>
      <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO train (id, name, train_type_id, from_station_id,</span>
<span class="s2">        to_station_id, departure_time, arrival_time) VALUES (%d, &#39;%s&#39;, %d, %d, %d, %d, %d);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nv">$train_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;train_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$from_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
        <span class="nv">$to_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$departure_time</span><span class="p">,</span> <span class="nv">$arrival_time</span><span class="p">);</span>
            <span class="nv">$num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$train</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$station</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO train_station (train_id, station_id, travel_time,</span>
<span class="s2">          arrival_time, departure_time, distance, sorder) VALUES (%d, %d, %d, %d, %d, %d, %d);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="nv">$train_id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;station_id&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
          <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;arrival_time&#39;</span><span class="p">],</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;departure_time&#39;</span><span class="p">],</span> <span class="nv">$station</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">],</span> <span class="nv">$num</span><span class="p">);</span>
                <span class="nv">$num</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$file_name</span> <span class="o">=</span> <span class="s1">&#39;../../_data/timetable.txt&#39;</span><span class="p">;</span>
<span class="nv">$i</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Import</span><span class="p">();</span>
<span class="nv">$i</span><span class="o">-&gt;</span><span class="na">do_import</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">);</span>
<span class="nv">$i</span><span class="o">-&gt;</span><span class="na">generateSQL</span><span class="p">();</span>
</pre></div></div></div>
<div class="paragraph"><p>Информацията за подвижния състав се намира във файла <strong>2010-TABLE1.RTF</strong>. Директната обработка на Rich Text Format е затруднена, затова първо експортваме файла в HTML формат, който след това изчистваме от HTML таговете и преобразуваме до файла <strong>processed.txt</strong>, съдържащ информацията за всеки влак на един ред. Файлът се обработва от скрипта <strong>wagons.php</strong>, който отново генерира SQL скрипт, готов за изпълнение на MySQL сървъра:</p></div>
<div class="listingblock">
<div class="title">wagons.php</div>
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nb">mb_internal_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">);</span>
<span class="nv">$re</span> <span class="o">=</span> <span class="s1">&#39;/([\d])([A-ZАВ]+)/u&#39;</span><span class="p">;</span>
<span class="nv">$lokre</span> <span class="o">=</span> <span class="s1">&#39;/(лок[\d]+)/u&#39;</span><span class="p">;</span>

<span class="nv">$text</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;../../_data/vagoni/processed.txt&#39;</span><span class="p">);</span>

<span class="nv">$arr</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="nx">PHP_EOL</span><span class="p">,</span> <span class="nv">$text</span><span class="p">);</span>

<span class="nv">$res</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="nv">$wagons</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="k">function</span> <span class="nf">fix</span><span class="p">(</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">str_replace</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;А&#39;</span><span class="p">,</span> <span class="s1">&#39;В&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">),</span>
    <span class="nv">$t</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$t</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="nv">$row</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$train_num</span> <span class="o">=</span> <span class="nv">$t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nv">$tr</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$lokre</span><span class="p">,</span> <span class="nv">$row</span><span class="p">,</span> <span class="nv">$m</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$lok</span> <span class="o">=</span> <span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$lok</span><span class="p">,</span> <span class="nv">$wagons</span><span class="p">))</span> <span class="p">{</span>
          <span class="nv">$wagons</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$lok</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$tr</span><span class="p">[</span><span class="nv">$lok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match_all</span><span class="p">(</span><span class="nv">$re</span><span class="p">,</span> <span class="nv">$row</span><span class="p">,</span> <span class="nv">$m</span><span class="p">,</span> <span class="nx">PREG_SET_ORDER</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$m</span> <span class="k">as</span> <span class="nv">$mrow</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$w</span> <span class="o">=</span> <span class="nx">fix</span><span class="p">(</span><span class="nv">$mrow</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$tr</span><span class="p">[</span><span class="nv">$w</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$tr</span><span class="p">[</span><span class="nv">$w</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$mrow</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$w</span><span class="p">,</span> <span class="nv">$wagons</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$wagons</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$w</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
<span class="c1">//        print_r($tr);</span>
      <span class="p">}</span>
      <span class="nv">$res</span><span class="p">[</span><span class="nv">$train_num</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tr</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">sort</span><span class="p">(</span><span class="nv">$wagons</span><span class="p">);</span>
<span class="c1">//print_r($wagons);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$wagons</span> <span class="k">AS</span> <span class="nv">$id</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO wagon_type (id, name) VALUES (%d, &#39;%s&#39;);&quot;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">,</span> <span class="p">(</span><span class="nv">$id</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nv">$row</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$res</span> <span class="k">as</span> <span class="nv">$train_num</span> <span class="o">=&gt;</span> <span class="nv">$lwagons</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$lwagons</span> <span class="k">as</span> <span class="nv">$type</span> <span class="o">=&gt;</span> <span class="nv">$cnt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="nv">$cnt</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$ndx</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$wagons</span><span class="p">);</span>
      <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;INSERT INTO train_wagon (train_id, wagon_type_id, sorder)</span>
<span class="s2">        VALUES (COALESCE((SELECT id FROM train WHERE name=&#39;%s&#39;), 0), %d, %d);&quot;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">,</span>
        <span class="nv">$train_num</span><span class="p">,</span> <span class="nv">$ndx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$n</span><span class="p">);</span>
      <span class="nv">$n</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></div></div>
<div class="paragraph"><p>Останалите данни: тарифната информация, GPS координати на гарите и подробностите за подвижния състав не беше достъпна в електронен вид, затова е заложена ръчно в SQL скрипта <strong>populate.sql</strong>, който е с големина над 2000 реда.</p></div>
<div class="paragraph"><p>Целият процес по изграждане и попълване на данните в MySQL е автоматизиран чрез следния Makefile:</p></div>
<div class="listingblock">
<div class="title">Makefile</div>
<div class="content"><div class="highlight"><pre><span class="nv">DBHOST</span> <span class="o">=</span> localhost
<span class="nv">DBUSER</span> <span class="o">=</span> username
<span class="nv">DBDB</span> <span class="o">=</span> database
<span class="nv">DBPASS</span> <span class="o">=</span> password

all: clean_database create_database populate

create_database:
    mysql -u <span class="k">$(</span>DBUSER<span class="k">)</span> -h <span class="k">$(</span>DBHOST<span class="k">)</span> --password<span class="o">=</span><span class="k">$(</span>DBPASS<span class="k">)</span> <span class="k">$(</span>DBDB<span class="k">)</span> &lt; create.sql

clean_database:
    mysql -u <span class="k">$(</span>DBUSER<span class="k">)</span> -h <span class="k">$(</span>DBHOST<span class="k">)</span> --password<span class="o">=</span><span class="k">$(</span>DBPASS<span class="k">)</span> <span class="k">$(</span>DBDB<span class="k">)</span> &lt; clean.sql

populate:
    php import.php | mysql -u <span class="k">$(</span>DBUSER<span class="k">)</span> -h <span class="k">$(</span>DBHOST<span class="k">)</span> --password<span class="o">=</span><span class="k">$(</span>DBPASS<span class="k">)</span> <span class="k">$(</span>DBDB<span class="k">)</span>
    php wagons.php | mysql -u <span class="k">$(</span>DBUSER<span class="k">)</span> -h <span class="k">$(</span>DBHOST<span class="k">)</span> --password<span class="o">=</span><span class="k">$(</span>DBPASS<span class="k">)</span> <span class="k">$(</span>DBDB<span class="k">)</span>
    mysql -u <span class="k">$(</span>DBUSER<span class="k">)</span> -h <span class="k">$(</span>DBHOST<span class="k">)</span> --password<span class="o">=</span><span class="k">$(</span>DBPASS<span class="k">)</span> <span class="k">$(</span>DBDB<span class="k">)</span> &lt; populate.sql
</pre></div></div></div>
<div class="paragraph"><p>Процесът се стартира чрез командата <strong>make</strong> при което последователно се извършват следните задачи:</p></div>
<div class="ulist"><ul>
<li>
<p>
унищожаване на всички таблици в базата данни (ако съществуват);
</p>
</li>
<li>
<p>
създаване на всички таблици в базата данни;
</p>
</li>
<li>
<p>
стартиране на import.php и изпълнение на резултата от скрипта на MySQL сървъра.
</p>
</li>
<li>
<p>
стартиране на wagons.php и изпълнение на резултата от скрипна на MySQL сървъра.
</p>
</li>
<li>
<p>
изпълнение на populate.sql на MySQL сървъра.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Задачите по унищожаване на данните, създаване на таблиците и попълване на данните могат да се стартират и индивидуално по желание.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="chapter-2-3">Разписание</h3>
<div class="paragraph"><p>Модулът <strong>razpisanie</strong> изпълнява една от двете основни цели на системата, да изготви близки до оптималния маршрути между две гари или спирки. Изискването към модула е да изпълнява търсенето възможно най-бързо и точно.</p></div>
<div class="paragraph"><p>Железопътната система може да се представи като симетричен насочен граф където всяка гара е връх от графа а всеки маршрут между две гари като насочена дъга с тегло разстоянието между двете гари по маршрута:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/sample_graph.svg" alt="Примерен граф">
</div>
<div class="title">Фигура 5. Примерен граф на железопътна мрежа</div>
</div>
<div class="paragraph"><p>Има множество алгоритми за намиране на пътища в граф но в случая ще използваме модификация на метода описан в DRUMURI OPTIME ÎN GRAFURI ORAR<a href="#cozac">[cozac]</a>.</p></div>
<div class="paragraph"><p>Входящите данни за модула са списък със следното съдържание:</p></div>
<div class="ulist"><ul>
<li>
<p>
идентификатор на превозно средство;
</p>
</li>
<li>
<p>
име на превозно средство;
</p>
</li>
<li>
<p>
идентификатор на гара;
</p>
</li>
<li>
<p>
име на гара;
</p>
</li>
<li>
<p>
час на пристигане;
</p>
</li>
<li>
<p>
час на заминаване;
</p>
</li>
<li>
<p>
разстояние от началната точка на маршрута;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Часовете на пристигане и заминаване са представени чрез брой минути от 0:00 часа а разстоянието е в стотици метри. Целта на тези преобразувания е да използваме цели числа като по този начин спестяваме памет и изчислително време. За разделител между колоните използваме стойността на константата <strong>SEPARATOR</strong>, дефинирана в <strong>constants.go</strong>, в случая вертикална черта "|";</p></div>
<div class="listingblock">
<div class="title">Опростени данни за движение по осма линия</div>
<div class="content monospaced">
<pre>120|7620|1|София|0|435|0
120|7620|215|Враца|542|544|1015
120|7620|341|Видин|725|0|2652
121|7621|341|Видин|0|365|0
121|7621|215|Враца|528|530|1637
121|7621|1|София|635|0|2653
122|7622|1|София|0|745|0
122|7622|215|Враца|868|870|1036
122|7622|341|Видин|1060|0|2673
124|7623|341|Видин|0|765|0
124|7623|215|Враца|948|950|1637
124|7623|1|София|1075|0|2673
125|7624|1|София|0|985|0
125|7624|215|Враца|1082|1084|1015
125|7624|341|Видин|1250|0|2652
126|7625|341|Видин|0|968|0
126|7625|215|Враца|1165|1167|1637
126|7625|1|София|1275|0|2653
127|7630|1|София|0|1150|0
127|7630|215|Враца|1269|1271|1036
127|7630|350|Лом|1377|0|2031
128|7631|350|Лом|0|335|0
128|7631|215|Враца|451|454|995
128|7631|1|София|588|0|2031</pre>
</div></div>
<div class="paragraph"><p>При стартиране на модула се изпълнява функцията <strong>StartServer</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">func</span> <span class="n">StartServer</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Създаване на нова глобална променлива за данните</span>
  <span class="n">razpisanie</span> <span class="p">=</span> <span class="n">NewRazpisanie</span><span class="p">()</span>
  <span class="c1">// Зареждане на входящите данни</span>
  <span class="n">razpisanie</span><span class="p">.</span><span class="n">LoadFromFile</span><span class="p">(</span><span class="s">&quot;data/paths.txt&quot;</span><span class="p">)</span>
  <span class="c1">// Обработка на данните</span>
  <span class="n">razpisanie</span><span class="p">.</span><span class="n">Process</span><span class="p">()</span>

  <span class="n">log</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s">&quot;Server operational&quot;</span><span class="p">)</span>
  <span class="c1">// Дефиниране на услугите на сървъра</span>
  <span class="n">http</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">&quot;/route&quot;</span><span class="p">,</span> <span class="n">http</span><span class="p">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">routeHandler</span><span class="p">))</span>
  <span class="n">http</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">&quot;/distance&quot;</span><span class="p">,</span> <span class="n">http</span><span class="p">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">distanceHandler</span><span class="p">))</span>
  <span class="c1">// Стартиране на сървъра</span>
  <span class="n">log</span><span class="p">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="p">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="n">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Razpisanie</strong> е основната функционална структура на модула. Затова променлива от тип Razpisanie е дефинирана като глобална за целия модул.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Основна функционална структура</span>
<span class="k">type</span> <span class="n">Razpisanie</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">tempList</span>   <span class="n">TempList</span>   <span class="c1">// Временен списък за данните при зареждане</span>
  <span class="n">stations</span>   <span class="p">*</span><span class="n">Dictionary</span>  <span class="c1">// Речник на гарите</span>
  <span class="n">trains</span>     <span class="p">*</span><span class="n">Dictionary</span>  <span class="c1">// Речник на превозните средства</span>
  <span class="n">floydGraph</span> <span class="n">FloydGraph</span> <span class="c1">// Матрица на теглата</span>
  <span class="n">dfsGraph</span>   <span class="n">DFSGraph</span>   <span class="c1">// Разширен граф</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зареждането на входящите данни се осъществява от функцията <strong>LoadFromFile</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Зареждане на данните от файл</span>
<span class="k">func</span> <span class="p">(</span><span class="n">raz</span> <span class="p">*</span><span class="n">Razpisanie</span><span class="p">)</span> <span class="n">LoadFromFile</span><span class="p">(</span><span class="n">file_name</span> <span class="nb">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Отваряне на файла за четене</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">os</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
    <span class="c1">// В случай на грешка прекъсваме работата на модула</span>
    <span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// Заявка за затваряне на файла след приключване на работа с него</span>
  <span class="k">defer</span> <span class="n">f</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

  <span class="c1">// Обект за буферирано четене от файлов дескриптор</span>
  <span class="n">reader</span> <span class="p">:=</span> <span class="n">bufio</span><span class="p">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

  <span class="n">line</span> <span class="p">:=</span> <span class="mi">1</span> <span class="c1">// Брояч на редове</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="c1">// Прочитане на ред от файла</span>
    <span class="n">rline</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">reader</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="k">break</span> <span class="c1">// Приключване на четенето</span>
    <span class="p">}</span>
    <span class="c1">// Разделяне на реда на елементи</span>
    <span class="n">array</span> <span class="p">:=</span> <span class="n">strings</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="n">rline</span><span class="p">),</span> <span class="n">SEPARATOR</span><span class="p">)</span>

    <span class="n">train_id</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">// Идентификатор на превозно средство</span>
    <span class="n">train_name</span> <span class="p">:=</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">// Име на превозно средство</span>
    <span class="n">station_id</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">// Идентификатор на гара</span>
    <span class="n">station_name</span> <span class="p">:=</span> <span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1">// Име на гара</span>

    <span class="k">var</span> <span class="n">row</span> <span class="n">TRow</span>  <span class="c1">// Нов ред-контейнер за временния списък</span>

    <span class="n">row</span><span class="p">.</span><span class="n">arrival</span><span class="p">,</span> <span class="n">_</span> <span class="p">=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">// Час на пристигане</span>
    <span class="n">row</span><span class="p">.</span><span class="n">departure</span><span class="p">,</span> <span class="n">_</span> <span class="p">=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c1">// Час на заминаване</span>
    <span class="n">row</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="p">=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="c1">// Дължина пътуването от началната точка</span>

    <span class="c1">// Добавяне на името и идентификатора на гара в речника за гари и</span>
    <span class="c1">// указване на вътрешния идентификатор във реда-контейнер</span>
    <span class="n">row</span><span class="p">.</span><span class="n">station</span> <span class="p">=</span> <span class="n">raz</span><span class="p">.</span><span class="n">stations</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">station_name</span><span class="p">)</span>
    <span class="c1">// Добавяне на името и идентификатора на превозно средство в речника за превозни</span>
    <span class="c1">// средства и указване на вътрешния идентификатор във реда-контейнер</span>
    <span class="n">row</span><span class="p">.</span><span class="n">train</span> <span class="p">=</span> <span class="n">raz</span><span class="p">.</span><span class="n">trains</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">train_id</span><span class="p">,</span> <span class="n">train_name</span><span class="p">)</span>

    <span class="c1">// Добавяне на реда-контейнер във временния списък</span>
    <span class="n">raz</span><span class="p">.</span><span class="n">tempList</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">raz</span><span class="p">.</span><span class="n">tempList</span><span class="p">,</span> <span class="p">&amp;</span><span class="n">row</span><span class="p">)</span>
    <span class="n">line</span><span class="p">++</span> <span class="c1">// Увеличаване на брояча на редове</span>
  <span class="p">}</span>
  <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">&quot;Loaded %d lines from \&quot;%s\&quot;\n&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Съхраняваме имената и идентификаторите на гарите и превозните средства в два речника за да използваме по-малко памет за съхранението на данните. Това също така опростява инициализирането на структурите за търсене в последствие.
Данните вече са налични но не са в удобен за употреба формат. Обработката им се поема от функцията <strong>Process</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Обработка на временния списък</span>
<span class="k">func</span> <span class="p">(</span><span class="n">raz</span> <span class="p">*</span><span class="n">Razpisanie</span><span class="p">)</span> <span class="n">Process</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Създаване на структурата за матрица на теглата</span>
  <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span> <span class="p">=</span> <span class="p">*(</span><span class="n">NewFloydGraph</span><span class="p">((*</span><span class="n">raz</span><span class="p">).</span><span class="n">stations</span><span class="p">.</span><span class="n">Len</span><span class="p">()))</span>
  <span class="c1">// Създаване на структурата за разширен граф</span>
  <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span> <span class="p">=</span> <span class="p">*(</span><span class="n">NewDFSGraph</span><span class="p">((*</span><span class="n">raz</span><span class="p">).</span><span class="n">stations</span><span class="p">.</span><span class="n">Len</span><span class="p">()))</span>

  <span class="c1">// Инициализация на променливите</span>
  <span class="k">var</span> <span class="p">(</span>
    <span class="n">last_station</span>  <span class="nb">int</span> <span class="p">=</span> <span class="p">-</span><span class="mi">1</span>
    <span class="n">last_train</span>    <span class="nb">int</span> <span class="p">=</span> <span class="p">-</span><span class="mi">1</span>
    <span class="n">last_distance</span>     <span class="p">=</span> <span class="mi">0</span>
    <span class="n">distance</span>          <span class="p">=</span> <span class="mi">0</span>

    <span class="n">node1</span> <span class="p">*</span><span class="n">DFSNode</span> <span class="p">=</span> <span class="n">nil</span>
    <span class="n">node2</span> <span class="p">*</span><span class="n">DFSNode</span> <span class="p">=</span> <span class="n">nil</span>
  <span class="p">)</span>


  <span class="c1">// Обработка на входящите данни</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">tempList</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">last_distance</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">distance</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span> <span class="n">last_distance</span>
    <span class="c1">//Floyd</span>
    <span class="k">if</span> <span class="n">last_station</span> <span class="p">!=</span> <span class="p">-</span><span class="mi">1</span> <span class="p">&amp;&amp;</span> <span class="n">row</span><span class="p">.</span><span class="n">train</span> <span class="p">==</span> <span class="n">last_train</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">last_distance</span> <span class="p">=</span> <span class="mi">0</span>
      <span class="p">}</span>
      <span class="c1">// Добавяме разстоянието в матрицата на теглата</span>
      <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">last_station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
      <span class="n">last_distance</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span>
    <span class="p">}</span>
    <span class="c1">//DFS</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">arrival</span> <span class="p">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="c1">// Добавяме нов връх от тип &quot;пристигане&quot;</span>
      <span class="n">node1</span> <span class="p">=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">AddTrainStation</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">train</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">arrival</span><span class="p">,</span> <span class="n">ARRIVAL</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">node1</span> <span class="p">=</span> <span class="n">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">node1</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">&amp;&amp;</span> <span class="n">node2</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="c1">// Добавяме дъга за продължаване на пътуването</span>
      <span class="n">node2</span><span class="p">.</span><span class="n">addArc</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">CONTINUE</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">departure</span> <span class="p">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="c1">// Добавяме нов връх от тип &quot;заминаване&quot;</span>
      <span class="n">node2</span> <span class="p">=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">AddTrainStation</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">train</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">departure</span><span class="p">,</span> <span class="n">DEPARTURE</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">node2</span> <span class="p">=</span> <span class="n">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">node1</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">&amp;&amp;</span> <span class="n">node2</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="c1">// Добавяме дъга за продължаване на пътуването</span>
      <span class="n">node1</span><span class="p">.</span><span class="n">addArc</span><span class="p">(</span><span class="n">node2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONTINUE</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">last_station</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span>
    <span class="n">last_train</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">train</span>
  <span class="p">}</span>
  <span class="c1">// Обработка на матрица на теглата</span>
  <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">.</span><span class="n">Resolve</span><span class="p">()</span>
  <span class="c1">// Обработка на разширен граф</span>
  <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">Init</span><span class="p">()</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>За реализация на търсенето се използват два алгоритъма от теория на графите: алгоритъм на <strong>Флойд-Уоршал</strong><a href="#nakov">[nakov]</a> и <strong>търсене в дълбочина на граф</strong><a href="#nakov">[nakov]</a></p></div>
<div class="paragraph"><p>Алгоритъмът на Флойд-Уоршал в случая се използва за определяне на минималните разстояния между всеки две точки в граф. Дефинираме матрица, представена от двумерен масив (в конкретната имплементация на езика Go използваме отрязъци за да използваме оптимално количество памет):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">type</span> <span class="n">FloydGraph</span> <span class="p">[][]</span><span class="nb">int</span>
</pre></div></div></div>
<div class="paragraph"><p>Инициализираме матрицата с размер броят на гарите и запълваме всички клетки със константната стойност <strong>INFINITY</strong>, дефинирана във файла <strong>constants.go</strong>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Създаване на нова матрица на теглата и инициализиране</span>
<span class="c1">// на всички клетки с INFINITY</span>
<span class="k">func</span> <span class="n">NewFloydGraph</span><span class="p">(</span><span class="n">num_stations</span> <span class="nb">int</span><span class="p">)</span> <span class="p">*</span><span class="n">FloydGraph</span> <span class="p">{</span>
  <span class="c1">// създаване на първото измерение на матрицата</span>
  <span class="n">fg</span> <span class="p">:=</span> <span class="nb">make</span><span class="p">(</span><span class="n">FloydGraph</span><span class="p">,</span> <span class="n">num_stations</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">x</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">fg</span> <span class="p">{</span>
    <span class="c1">// създаване на второто измерение</span>
    <span class="n">fg</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nb">int</span><span class="p">,</span> <span class="n">num_stations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">fg</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">{</span>
      <span class="c1">// инициализиране на клетките</span>
      <span class="n">fg</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="p">=</span> <span class="n">INFINITY</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">&amp;</span><span class="n">fg</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Добавяме всички известни разстояния между гарите:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="c1">// Обработка на входящите данни</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">tempList</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">last_distance</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">distance</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span> <span class="n">last_distance</span>
    <span class="c1">//Floyd</span>
    <span class="k">if</span> <span class="n">last_station</span> <span class="p">!=</span> <span class="p">-</span><span class="mi">1</span> <span class="p">&amp;&amp;</span> <span class="n">row</span><span class="p">.</span><span class="n">train</span> <span class="p">==</span> <span class="n">last_train</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">last_distance</span> <span class="p">=</span> <span class="mi">0</span>
      <span class="p">}</span>
      <span class="c1">// Добавяме разстоянието в матрицата на теглата</span>
      <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">last_station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
      <span class="n">last_distance</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span>
    <span class="p">}</span>

    <span class="c1">// ....</span>

    <span class="n">last_station</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span>
    <span class="n">last_train</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">train</span>
  <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>И стартираме стартираме самият алгоритъм:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// връщаме по-малкото от две цели числа</span>
<span class="k">func</span> <span class="n">MinInt</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">v1</span> <span class="p">&lt;=</span> <span class="n">v2</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">v1</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">v2</span>
<span class="p">}</span>

<span class="c1">// Определяне на минимални пътища между върхове на граф</span>
<span class="c1">// по алгоритъм на Флойд-Уоршал</span>
<span class="k">func</span> <span class="p">(</span><span class="n">fg</span> <span class="p">*</span><span class="n">FloydGraph</span><span class="p">)</span> <span class="n">Resolve</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">n</span> <span class="p">:=</span> <span class="nb">len</span><span class="p">(*</span><span class="n">fg</span><span class="p">)</span> <span class="c1">// Размерността на матрицата</span>
  <span class="k">for</span> <span class="n">k</span> <span class="p">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">k</span><span class="p">++</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">i</span> <span class="p">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">{</span>
      <span class="k">for</span> <span class="n">j</span> <span class="p">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="p">++</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">i</span> <span class="p">==</span> <span class="n">j</span> <span class="p">{</span>
          <span class="p">(*</span><span class="n">fg</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// Разстоянието от гарата до самата нея винаги е 0</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="p">(*</span><span class="n">fg</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">MinInt</span><span class="p">((*</span><span class="n">fg</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="p">(*</span><span class="n">fg</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]+(*</span><span class="n">fg</span><span class="p">)[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Състоянието на матрицата преди и след обработката са дадени съответно в <strong>Таблица 2</strong> и <strong>Таблица 3</strong>:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:30%;
">
<caption class="title">Таблица 2. Матрица на теглата преди изчисляване на разстоянията</caption>
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >   </th>
<th class="tableblock halign-right valign-top" >София </th>
<th class="tableblock halign-right valign-top" >Враца </th>
<th class="tableblock halign-right valign-top" >Видин </th>
<th class="tableblock halign-right valign-top" >Лом</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">София</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1036</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Враца</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1036</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1637</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>995</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Видин</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1637</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Лом</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>995</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>999999</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><em>стойностите са в стотици метри</em></p></div>
<table class="tableblock frame-all grid-all"
style="
width:30%;
">
<caption class="title">Таблица 3. Матрица на теглата след изчисляване на разстоянията</caption>
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >   </th>
<th class="tableblock halign-right valign-top" >София </th>
<th class="tableblock halign-right valign-top" >Враца </th>
<th class="tableblock halign-right valign-top" >Видин </th>
<th class="tableblock halign-right valign-top" >Лом</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">София</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>0</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1036</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2673</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2031</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Враца</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1036</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>0</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1637</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>995</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Видин</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2673</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>1637</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>0</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2632</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock header">Лом</p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2031</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>995</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>2632</strong></p></td>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><strong>0</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><em>стойностите са в стотици метри</em></p></div>
<div class="paragraph"><p>След обработката на матрицата, можем да достъпваме разстоянията чрез функцията <strong>GetDistance</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Разстояние между гари x и y</span>
<span class="k">func</span> <span class="p">(</span><span class="n">fg</span> <span class="p">*</span><span class="n">FloydGraph</span><span class="p">)</span> <span class="n">GetDistance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(*</span><span class="n">fg</span><span class="p">)[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>За <strong>търсене в дълбочина на граф</strong> изграждаме разширен граф с цел ускоряване на търсенето на маршрути. Графът е представен от следните структури:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Разширен граф</span>
<span class="k">type</span> <span class="n">DFSGraph</span> <span class="p">[]*</span><span class="n">NodeColumn</span>

<span class="c1">// Колона на гара</span>
<span class="k">type</span> <span class="n">NodeColumn</span> <span class="p">[]*</span><span class="n">DFSNode</span>

<span class="c1">// Връх</span>
<span class="k">type</span> <span class="n">DFSNode</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">station</span> <span class="nb">int</span>     <span class="c1">// гара</span>
  <span class="n">train</span>   <span class="nb">int</span>     <span class="c1">// влак</span>
  <span class="n">time</span>    <span class="nb">int</span>     <span class="c1">// време(минути)</span>
  <span class="n">ntype</span>   <span class="n">bool</span>    <span class="c1">// тип на върха</span>
  <span class="n">arcs</span>    <span class="p">[]*</span><span class="n">DFSArc</span>   <span class="c1">// списък дъги</span>
<span class="p">}</span>

<span class="c1">// Дъга</span>
<span class="k">type</span> <span class="n">DFSArc</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">next</span>   <span class="p">*</span><span class="n">DFSNode</span>   <span class="c1">// връх</span>
  <span class="n">length</span> <span class="nb">int</span>      <span class="c1">// тегло (дължина)</span>
  <span class="n">atype</span>  <span class="n">bool</span>     <span class="c1">// тип на дъгата</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Графът се състои от колони като всяка една колона представлява гара. Във всяка колона са подредени по време върховете а всеки връх съдържа в себе си списък с връзки към други върхове от графа:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/extended_graph2.svg" alt="Разширен граф" width="640">
</div>
<div class="title">Фигура 6. Разширен граф на движението по осма линия</div>
</div>
<div class="paragraph"><p>На фигура 6, нормалното движение на влаковете е представено с плътни стрелки а трансферните дъги са означени с пунктир.</p></div>
<div class="paragraph"><p>Разширен граф ще наричаме такъв насочен граф за който всеки връх е комбинация от гара, влак и час а всяка дъга свързва два върха с тегло равно на разстоянието между гарите на двата върха.</p></div>
<div class="paragraph"><p>Точките биват два вида: на пристигане и на потегляне, представени от една булева променлива: <strong>ntype</strong> със стойности дефинирани във файла <strong>constants.go</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">const</span> <span class="p">(</span>
  <span class="c1">// ...</span>
  <span class="n">DEPARTURE</span> <span class="p">=</span> <span class="n">true</span>  <span class="c1">// заминаване</span>
  <span class="n">ARRIVAL</span>   <span class="p">=</span> <span class="n">false</span> <span class="c1">// пристигане</span>
  <span class="c1">// ...</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Дъгите също биват два вида: движение на влака и трансферни също представени от една булева променлива: <strong>atype</strong>  със стойности дефинирани във файла <strong>constants.go</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">const</span> <span class="p">(</span>
  <span class="c1">// ...</span>
  <span class="n">CONTINUE</span> <span class="p">=</span> <span class="n">true</span>   <span class="c1">// движение на влака</span>
  <span class="n">TRANSFER</span> <span class="p">=</span> <span class="n">false</span>  <span class="c1">// трансфер</span>
  <span class="c1">// ...</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>При създаване на разширеният граф, създаваме колоните, като всяка от тях ще съдържа върхове са една и съща гара:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Създаване на нов разширен граф</span>
<span class="k">func</span> <span class="n">NewDFSGraph</span><span class="p">(</span><span class="n">num_stations</span> <span class="nb">int</span><span class="p">)</span> <span class="p">*</span><span class="n">DFSGraph</span> <span class="p">{</span>
  <span class="n">dfs</span> <span class="p">:=</span> <span class="nb">make</span><span class="p">(</span><span class="n">DFSGraph</span><span class="p">,</span> <span class="n">num_stations</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="p">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">num_stations</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">{</span>
    <span class="c1">// Създаване на колона за всяка гара</span>
    <span class="n">dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">NewNodeColumn</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">&amp;</span><span class="n">dfs</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Информацията в разширения граф се попълва паралелно с тази в матрицата на теглата, при обработката на входящите данни:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="c1">// Обработка на входящите данни</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">tempList</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="n">last_distance</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">distance</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span> <span class="n">last_distance</span>

    <span class="c1">// ....</span>

    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">arrival</span> <span class="p">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="c1">// Добавяме нов връх от тип &quot;пристигане&quot;</span>
      <span class="n">node1</span> <span class="p">=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">AddTrainStation</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">train</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">arrival</span><span class="p">,</span> <span class="n">ARRIVAL</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">node1</span> <span class="p">=</span> <span class="n">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">node1</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">&amp;&amp;</span> <span class="n">node2</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="c1">// Добавяме дъга за продължаване на пътуването</span>
      <span class="n">node2</span><span class="p">.</span><span class="n">addArc</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">CONTINUE</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">.</span><span class="n">departure</span> <span class="p">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="c1">// Добавяме нов връх от тип &quot;заминаване&quot;</span>
      <span class="n">node2</span> <span class="p">=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">AddTrainStation</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">train</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">row</span><span class="p">.</span><span class="n">departure</span><span class="p">,</span> <span class="n">DEPARTURE</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">node2</span> <span class="p">=</span> <span class="n">nil</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">node1</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">&amp;&amp;</span> <span class="n">node2</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="c1">// Добавяме дъга за продължаване на пътуването</span>
      <span class="n">node1</span><span class="p">.</span><span class="n">addArc</span><span class="p">(</span><span class="n">node2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONTINUE</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">last_station</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">station</span>
    <span class="n">last_train</span> <span class="p">=</span> <span class="n">row</span><span class="p">.</span><span class="n">train</span>
  <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Използваме два метода за запълване на графа:</p></div>
<div class="paragraph"><p>добавяне на нов връх:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Създаване на нов връх</span>
<span class="k">func</span> <span class="n">NewNode</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">time</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ntype</span> <span class="n">bool</span><span class="p">)</span> <span class="p">*</span><span class="n">DFSNode</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&amp;</span><span class="n">DFSNode</span><span class="p">{</span><span class="n">station</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">ntype</span><span class="p">,</span> <span class="n">nil</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Добавяне на връх в графа</span>
<span class="k">func</span> <span class="p">(</span><span class="n">dfs</span> <span class="p">*</span><span class="n">DFSGraph</span><span class="p">)</span> <span class="n">addNode</span><span class="p">(</span><span class="n">station</span> <span class="nb">int</span><span class="p">,</span> <span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">nc</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">dfs</span><span class="p">)[</span><span class="n">station</span><span class="p">]</span>
  <span class="n">nnc</span> <span class="p">:=</span> <span class="n">append</span><span class="p">(*</span><span class="n">nc</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
  <span class="p">(*</span><span class="n">dfs</span><span class="p">)[</span><span class="n">station</span><span class="p">]</span> <span class="p">=</span> <span class="p">&amp;</span><span class="n">nnc</span>
<span class="p">}</span>

<span class="c1">// Добавяне на връх</span>
<span class="k">func</span> <span class="p">(</span><span class="n">dfs</span> <span class="p">*</span><span class="n">DFSGraph</span><span class="p">)</span> <span class="n">AddTrainStation</span><span class="p">(</span><span class="n">train</span> <span class="nb">int</span><span class="p">,</span> <span class="n">station</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ntype</span> <span class="n">bool</span><span class="p">)</span> <span class="p">*</span><span class="n">DFSNode</span> <span class="p">{</span>
  <span class="n">node</span> <span class="p">:=</span> <span class="n">NewNode</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">ntype</span><span class="p">)</span>  <span class="c1">//Създаваме нов връх</span>
  <span class="n">dfs</span><span class="p">.</span><span class="n">addNode</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="c1">// Добавяме върхът в графа</span>
  <span class="k">return</span> <span class="n">node</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>и добавяне на дъга свързваща два върха:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Създаване на нова дъга</span>
<span class="k">func</span> <span class="n">NewArc</span><span class="p">(</span><span class="n">next</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">,</span> <span class="n">length</span> <span class="nb">int</span><span class="p">,</span> <span class="n">atype</span> <span class="n">bool</span><span class="p">)</span> <span class="p">*</span><span class="n">DFSArc</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&amp;</span><span class="n">DFSArc</span><span class="p">{</span><span class="n">next</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">atype</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Добавяне на дъга между два върха</span>
<span class="k">func</span> <span class="p">(</span><span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">)</span> <span class="n">addArc</span><span class="p">(</span><span class="n">next</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">,</span> <span class="n">length</span> <span class="nb">int</span><span class="p">,</span> <span class="n">atype</span> <span class="n">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Добавя нов дъга към списъка с дъги на текущия връх</span>
  <span class="n">node</span><span class="p">.</span><span class="n">arcs</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">arcs</span><span class="p">,</span> <span class="n">NewArc</span><span class="p">(</span><span class="n">next</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">atype</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>След запълването на графа с върхове и дъгите за движение на влака, предстои изграждането на трансферните дъги:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Проверка за възможен трансфер между влакове</span>
<span class="k">func</span> <span class="p">(</span><span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">)</span> <span class="n">canTransferTo</span><span class="p">(</span><span class="n">next</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">)</span> <span class="n">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">ntype</span> <span class="p">==</span> <span class="n">ARRIVAL</span> <span class="p">&amp;&amp;</span> <span class="c1">// Влак 1 пристига</span>
    <span class="n">next</span><span class="p">.</span><span class="n">ntype</span> <span class="p">==</span> <span class="n">DEPARTURE</span> <span class="p">&amp;&amp;</span> <span class="c1">// Влак 2 заминава</span>
    <span class="n">node</span><span class="p">.</span><span class="n">train</span> <span class="p">!=</span> <span class="n">next</span><span class="p">.</span><span class="n">train</span> <span class="p">&amp;&amp;</span> <span class="c1">// Влак 1 &lt;&gt; Влак 2</span>
    <span class="n">next</span><span class="p">.</span><span class="n">time</span><span class="p">-</span><span class="n">node</span><span class="p">.</span><span class="n">time</span> <span class="p">&gt;=</span> <span class="n">MIN_TRANSFER_TIME</span> <span class="p">&amp;&amp;</span> <span class="c1">// Времето между двете събития е по-голямо или равно на минималното трансферно време</span>
    <span class="n">next</span><span class="p">.</span><span class="n">time</span><span class="p">-</span><span class="n">node</span><span class="p">.</span><span class="n">time</span> <span class="p">&lt;=</span> <span class="n">MAX_TRANSFER_TIME</span> <span class="c1">// Времето между двете събития е по-малко или равно на максималното трансферно време</span>
<span class="p">}</span>

<span class="c1">// Инициализиране на трансферните дъги</span>
<span class="k">func</span> <span class="p">(</span><span class="n">dfs</span> <span class="p">*</span><span class="n">DFSGraph</span><span class="p">)</span> <span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">nc</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">*</span><span class="n">dfs</span> <span class="p">{</span>
    <span class="n">sort</span><span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span> <span class="c1">// Сортираме върховете във всяка гара по време</span>
    <span class="n">c</span> <span class="p">:=</span> <span class="n">nc</span><span class="p">.</span><span class="n">Len</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">*</span><span class="n">nc</span> <span class="p">{</span>
      <span class="k">for</span> <span class="n">j</span> <span class="p">:=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">c</span><span class="p">;</span> <span class="n">j</span><span class="p">++</span> <span class="p">{</span>
        <span class="c1">// Ако е възможен трансферът между два върха</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">canTransferTo</span><span class="p">((*</span><span class="n">nc</span><span class="p">)[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
          <span class="c1">// Създаваме трансферна дъга</span>
          <span class="n">node</span><span class="p">.</span><span class="n">addArc</span><span class="p">((*</span><span class="n">nc</span><span class="p">)[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRANSFER</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>За сортиране на всяка колона с върхове използваме вграденият алгоритъм на езика Go като сме дефинирали интерфейса за сортиране по следния начин:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Брой елементи в колоната</span>
<span class="k">func</span> <span class="p">(</span><span class="n">nc</span> <span class="p">*</span><span class="n">NodeColumn</span><span class="p">)</span> <span class="n">Len</span><span class="p">()</span> <span class="nb">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(*</span><span class="n">nc</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Компаратор</span>
<span class="k">func</span> <span class="p">(</span><span class="n">nc</span> <span class="p">*</span><span class="n">NodeColumn</span><span class="p">)</span> <span class="n">Less</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="nb">int</span><span class="p">)</span> <span class="n">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">i</span><span class="p">].</span><span class="n">time</span> <span class="p">&lt;</span> <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">j</span><span class="p">].</span><span class="n">time</span> <span class="c1">// Сравняваме по време</span>
<span class="p">}</span>

<span class="c1">// Разменяне на местата на два върха</span>
<span class="k">func</span> <span class="p">(</span><span class="n">nc</span> <span class="p">*</span><span class="n">NodeColumn</span><span class="p">)</span> <span class="n">Swap</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">j</span><span class="p">],</span> <span class="p">(*</span><span class="n">nc</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>След като сме сигурни че върховете са сортирани. За всеки връх проверяваме дали между него и някой от следващите върхове е възможно да се осъществи трансфер. Ако такъв е възможен създаваме трансферна дъга между двата върха.</p></div>
<div class="paragraph"><p>Целта на използването на разширен граф е да преизчислим възможно най-много условия в процеса на инициализация на структурата, за да можем да изпълняваме по-малко операции след това в търсенето на пътища.</p></div>
<div class="paragraph"><p>На този етап сме извършили зареждането и инициализацията на данните и сме ги подготвили за употреба. Ред е на стартирането на WEB сървъра:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">func</span> <span class="n">StartServer</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Създаване на нова глобална променлива за данните</span>
  <span class="n">razpisanie</span> <span class="p">=</span> <span class="n">NewRazpisanie</span><span class="p">()</span>
  <span class="c1">// Зареждане на входящите данни</span>
  <span class="n">razpisanie</span><span class="p">.</span><span class="n">LoadFromFile</span><span class="p">(</span><span class="s">&quot;data/paths.txt&quot;</span><span class="p">)</span>
  <span class="c1">// Обработка на данните</span>
  <span class="n">razpisanie</span><span class="p">.</span><span class="n">Process</span><span class="p">()</span>

  <span class="n">log</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s">&quot;Server operational&quot;</span><span class="p">)</span>
  <span class="c1">// Дефиниране на услугите на сървъра</span>
  <span class="n">http</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">&quot;/route&quot;</span><span class="p">,</span> <span class="n">http</span><span class="p">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">routeHandler</span><span class="p">))</span>
  <span class="n">http</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">&quot;/distance&quot;</span><span class="p">,</span> <span class="n">http</span><span class="p">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="n">distanceHandler</span><span class="p">))</span>
  <span class="c1">// Стартиране на сървъра</span>
  <span class="n">log</span><span class="p">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="p">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="n">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Сървърът предлага две услуги <strong>route</strong> и <strong>distance</strong> през HTTP протокол на порт 8080;</p></div>
<div class="paragraph"><p>Услугата <strong>distance</strong> връща минималното разстояние между две гари от графа. Тъй като имаме изчислени всички разстояния от обработката на матрицата на теглата с алгоритъмът на Флойд-Уоршал, реализацията на услугата е тривиална:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Реализация на услугата distance</span>
<span class="k">func</span> <span class="n">distanceHandler</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="p">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Идентификатор на начална гара</span>
  <span class="n">fromid</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">))</span>
  <span class="c1">// Идентификатор на крайна гара</span>
  <span class="n">toid</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">))</span>
  <span class="c1">// Вътрешен идентификатор на начална гара</span>
  <span class="n">from</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">stations</span><span class="p">.</span><span class="n">FindId</span><span class="p">(</span><span class="n">fromid</span><span class="p">)</span>
  <span class="c1">// Вътрешен идентификатор на крайна гара</span>
  <span class="n">to</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">stations</span><span class="p">.</span><span class="n">FindId</span><span class="p">(</span><span class="n">toid</span><span class="p">)</span>

  <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">&quot;Distance from: %d\tto: %d&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="c1">// Разстоянието се получава директно от матрицата на теглата</span>
  <span class="n">p</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">FindDistance</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="c1">// Връщане на резултата към клиента</span>
  <span class="n">fmt</span><span class="p">.</span><span class="n">Fprint</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">raz</span> <span class="p">*</span><span class="n">Razpisanie</span><span class="p">)</span> <span class="n">FindDistance</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Услугата <strong>route</strong> предоставя оптималния и близки до оптималния (ако са възможни) маршрути между две гари. Услугата се реализиран от следната функция:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Реализация на услугата route</span>
<span class="k">func</span> <span class="n">routeHandler</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="p">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Идентификатор на начална гара</span>
  <span class="n">fromid</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">))</span>
  <span class="c1">// Идентификатор на крайна гара</span>
  <span class="n">toid</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">))</span>
  <span class="c1">// Вътрешен идентификатор на начална гара</span>
  <span class="n">from</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">stations</span><span class="p">.</span><span class="n">FindId</span><span class="p">(</span><span class="n">fromid</span><span class="p">)</span>
  <span class="c1">// Вътрешен идентификатор на крайна гара</span>
  <span class="n">to</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">stations</span><span class="p">.</span><span class="n">FindId</span><span class="p">(</span><span class="n">toid</span><span class="p">)</span>

  <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">&quot;Search from: %d\tto: %d&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="c1">// Търсене на маршрути</span>
  <span class="n">p</span> <span class="p">:=</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">FindRoutes</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="c1">// Изграждане на JSON формат на резултата</span>
  <span class="n">fmt</span><span class="p">.</span><span class="n">Fprint</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Encode</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>За успешна работа, изисква подаването на два параметъра чрез <strong>POST</strong> заявка:
- <strong>from</strong> - идентификатор на начална гара;
- <strong>to</strong> - идентификатор на крайна гара;</p></div>
<div class="paragraph"><p>Двата идентификатора се преобразуват във вътрешни идентификатори и се подават на функцията <strong>FindRoutes</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Търсене на близки до оптималния маршрути</span>
<span class="k">func</span> <span class="p">(</span><span class="n">raz</span> <span class="p">*</span><span class="n">Razpisanie</span><span class="p">)</span> <span class="n">FindRoutes</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span> <span class="nb">int</span><span class="p">)</span> <span class="p">*</span><span class="n">Paths</span> <span class="p">{</span>
  <span class="c1">// Минимално разстояние между две гари</span>
  <span class="n">min_distance</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="k">var</span> <span class="n">p</span> <span class="p">*</span><span class="n">Paths</span> <span class="p">=</span> <span class="n">nil</span> <span class="c1">// Нов контейнер за маршрути</span>
  <span class="c1">// Започва проверката от маршрути без прехвърляне като се увеличават възможните</span>
  <span class="c1">// прехвърляния с единица докато не се получи възможен по смисъла на ограниченията</span>
  <span class="c1">// маршрут(и)</span>
  <span class="k">for</span> <span class="n">max_transfers</span> <span class="p">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">max_transfers</span> <span class="p">&lt;=</span> <span class="n">MAX_TRANSFERS</span><span class="p">;</span> <span class="n">max_transfers</span><span class="p">++</span> <span class="p">{</span>
    <span class="c1">// Търсене в дълбочина на разширен граф</span>
    <span class="n">p</span> <span class="p">=</span> <span class="p">(*</span><span class="n">raz</span><span class="p">).</span><span class="n">dfsGraph</span><span class="p">.</span><span class="n">FindRoutes</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="n">min_distance</span><span class="p">)*</span><span class="n">DISTANCE_COEF</span><span class="p">),</span> <span class="p">&amp;(*</span><span class="n">raz</span><span class="p">).</span><span class="n">floydGraph</span><span class="p">,</span> <span class="n">max_transfers</span><span class="p">)</span>
    <span class="c1">// В случай на резултат търсенето се прекратява</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">((*</span><span class="n">p</span><span class="p">).</span><span class="n">paths</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="c1">// Връщане на откритите резултати</span>
      <span class="k">return</span> <span class="n">p</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Тъй като в общия случай, маршрутите между две върха на графа са много, като в конкретния случай малка само част от тях са рентабилни, поставяме няколко ограничаващи условия на търсенето:</p></div>
<div class="ulist"><ul>
<li>
<p>
възможно най-малко прехвърляния между превозни средства. Започваме проверките от пътуване без прехвърляне и увеличаваме броя на прехвърлянията с единица докато не получим възможен маршрут. За налагането на това ограничение изхождаме от презюмцията че прехвърлянията са неудобни за пътника и болшинството клиенти при предоставени два маршрута с еднакви други параметри биха предпочели този с по-малко прехвърляне;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Максималният брой прехвърляния е константа, дефинирана в <strong>constants.go</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="n">MAX_TRANSFERS</span> <span class="p">=</span> <span class="mi">4</span> <span class="c1">// Максимален брой прехвърляния</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
дължина на маршрута по-малка или равна на минималната дължина между двете гари умножена по коефициент за разстояние:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="n">DISTANCE_COEF</span> <span class="p">=</span> <span class="mf">1.2</span> <span class="c1">// Коефициент на разстояние</span>
</pre></div></div></div>
<div class="paragraph"><p>В този случай приемаме, че маршрути с дължина 20% над минималната, все още са рентабилни за пътника;</p></div>
<div class="paragraph"><p>Търсенето в дълбочина на граф е алгоритъм измислен още през 19 век като метод за откриване на пътища в лабиринт. Алгоритъмът е рекурсивен и се състои в последователно обхождане на всички дъги на даден връх докато не се достигне до желания краен връх.</p></div>
<div class="paragraph"><p>Ще използваме модификация на алгоритъмът с употреба на стек за да можем да използваме едни и същи данни за едновременно търсене от много клиенти:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Търсене в дълбочина на граф</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="p">*</span><span class="n">Paths</span><span class="p">)</span> <span class="n">FindWay</span><span class="p">(</span><span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">,</span> <span class="n">end_station</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">transfers</span><span class="p">,</span> <span class="n">max_transfers</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// При достигане на крайната гара</span>
  <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">station</span> <span class="p">==</span> <span class="n">end_station</span> <span class="p">{</span>
    <span class="c1">// Добавяне на крайната гара в стека</span>
    <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">NewStackNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nil</span><span class="p">))</span>
    <span class="c1">// Копиране на стека в списъка с маршрути</span>
    <span class="n">p</span><span class="p">.</span><span class="n">AddPath</span><span class="p">()</span>
    <span class="c1">// Изкарване на последната гара от стека</span>
    <span class="n">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Обхождане на всички дъги за върха</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">arc</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">node</span><span class="p">.</span><span class="n">arcs</span> <span class="p">{</span>
      <span class="c1">// Ако дъгата не е крайна т.е последна гара</span>
      <span class="k">if</span> <span class="n">arc</span><span class="p">.</span><span class="n">next</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="c1">// Забранява прехвърлянето за начална гара</span>
        <span class="k">if</span> <span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span> <span class="n">arc</span><span class="p">.</span><span class="n">atype</span> <span class="p">==</span> <span class="n">TRANSFER</span> <span class="p">{</span>
          <span class="k">continue</span>
        <span class="p">}</span>
        <span class="c1">// Разстоянието от текущата гара до крайната гара</span>
        <span class="n">now</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">floyd</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">end_station</span><span class="p">)</span>
        <span class="c1">// Разстоянието от следващата гара до крайната гара</span>
        <span class="n">next</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">floyd</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">arc</span><span class="p">.</span><span class="n">next</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">end_station</span><span class="p">)</span>
        <span class="c1">// Проверка дали следваща гара ни доближава до целта,</span>
        <span class="c1">// дали разстоянието не надхвърля максималното разстояние,</span>
        <span class="c1">// дали броят прехвърляния не надхвърля максималният брой прехвърляния</span>
        <span class="k">if</span> <span class="n">now</span> <span class="p">&gt;=</span> <span class="n">next</span> <span class="p">&amp;&amp;</span> <span class="n">arc</span><span class="p">.</span><span class="n">length</span><span class="p">+</span><span class="n">length</span> <span class="p">&lt;=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">max_distance</span> <span class="p">&amp;&amp;</span> <span class="n">transfers</span> <span class="p">&lt;=</span> <span class="n">max_transfers</span> <span class="p">{</span>
          <span class="c1">// Добавяме следващия връх и дъгата до него в стека</span>
          <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">NewStackNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">arc</span><span class="p">))</span>
          <span class="c1">// Ако дъгата е прехвърляне, увеличаваме броят на прехвърлянията</span>
          <span class="n">add</span> <span class="p">:=</span> <span class="mi">0</span>
          <span class="k">if</span> <span class="n">arc</span><span class="p">.</span><span class="n">atype</span> <span class="p">==</span> <span class="n">TRANSFER</span> <span class="p">{</span>
            <span class="n">add</span> <span class="p">=</span> <span class="mi">1</span>
          <span class="p">}</span>
          <span class="c1">// Викаме търсене в дълбочина с новия връх</span>
          <span class="n">p</span><span class="p">.</span><span class="n">FindWay</span><span class="p">(</span><span class="n">arc</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">end_station</span><span class="p">,</span> <span class="n">length</span><span class="p">+</span><span class="n">arc</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="n">transfers</span> <span class="p">+</span> <span class="n">add</span><span class="p">),</span> <span class="n">max_transfers</span><span class="p">)</span>
          <span class="c1">// Изваждаме последния елемент от стека</span>
          <span class="n">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>В стека съхраняваме комбинация от указатели към връх и дъга до него за не губим информация за разстоянието между два върха, което се носи в дъгите.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">type</span> <span class="n">StackNode</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span> <span class="c1">// Връх</span>
  <span class="n">arc</span>  <span class="p">*</span><span class="n">DFSArc</span>  <span class="c1">// Дъга</span>
<span class="p">}</span>

<span class="c1">// Създаване на нов елемент за стека</span>
<span class="k">func</span> <span class="n">NewStackNode</span><span class="p">(</span><span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">,</span> <span class="n">arc</span> <span class="p">*</span><span class="n">DFSArc</span><span class="p">)</span> <span class="p">*</span><span class="n">StackNode</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">&amp;</span><span class="n">StackNode</span><span class="p">{</span><span class="n">node</span><span class="p">,</span> <span class="n">arc</span><span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>В списъка с маршрутите съхраняваме копие на текущия стек:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Добавяне на стек към списъкът с маршрути</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="p">*</span><span class="n">Paths</span><span class="p">)</span> <span class="n">AddPath</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//Създаване на копие на текущия стек</span>
  <span class="n">ns</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">stack</span><span class="p">.</span><span class="n">Copy</span><span class="p">()</span>
  <span class="n">p</span><span class="p">.</span><span class="n">paths</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">paths</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>След приключване на търсенето, структурата <strong>Paths</strong> съдържа списък с откритите маршрути между началната и крайна гара:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">type</span> <span class="n">Paths</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">max_distance</span> <span class="nb">int</span>      <span class="c1">// Максимално разстояние</span>
  <span class="n">floyd</span>        <span class="p">*</span><span class="n">FloydGraph</span>  <span class="c1">// Матрица на теглата</span>
  <span class="n">stack</span>        <span class="p">*</span><span class="n">Stack</span>     <span class="c1">// Текущ стек</span>
  <span class="n">paths</span>        <span class="p">[]*</span><span class="n">Stack</span>   <span class="c1">// Списък маршрути</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Така получените данни са в суров вид, съдържат пълните пътища между двете точки. За целите на сайта имаме нужда само от от интервалите между значещите гари (начална, крайна и трансферна). Данните се подготвят за клиента от функцията <strong>Encode</strong> като се ползват експортни структури чрез които резултатът автоматично се конвертира във JSON формат:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Експортна структура</span>
<span class="k">type</span> <span class="n">JSONStack</span> <span class="p">[]</span><span class="n">JSONPath</span>

<span class="c1">// Маршрут</span>
<span class="k">type</span> <span class="n">JSONPath</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">From_Station_Id</span> <span class="nb">int</span>       <span class="s">`json:&quot;from_station_id&quot;`</span>
  <span class="n">To_Station_Id</span>   <span class="nb">int</span>       <span class="s">`json:&quot;to_station_id&quot;`</span>
  <span class="n">Distance</span>        <span class="nb">int</span>       <span class="s">`json:&quot;distance&quot;`</span>
  <span class="n">Transfers</span>       <span class="nb">int</span>       <span class="s">`json:&quot;transfers&quot;`</span>
  <span class="n">Departure_Time</span>  <span class="nb">int</span>       <span class="s">`json:&quot;departure_time&quot;`</span>
  <span class="n">Arrival_Time</span>    <span class="nb">int</span>       <span class="s">`json:&quot;arrival_time&quot;`</span>
  <span class="n">Details</span>         <span class="p">[]</span><span class="n">JSONDetail</span>  <span class="s">`json:&quot;details&quot;`</span>
<span class="p">}</span>

<span class="c1">// Сегмент от маршрута</span>
<span class="k">type</span> <span class="n">JSONDetail</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Train_Id</span>        <span class="nb">int</span>       <span class="s">`json:&quot;train_id&quot;`</span>
  <span class="n">From_Station_Id</span> <span class="nb">int</span>       <span class="s">`json:&quot;from_station_id&quot;`</span>
  <span class="n">To_Station_Id</span>   <span class="nb">int</span>       <span class="s">`json:&quot;to_station_id&quot;`</span>
  <span class="n">Distance</span>        <span class="nb">int</span>       <span class="s">`json:&quot;distance&quot;`</span>
  <span class="n">Departure_Time</span>  <span class="nb">int</span>       <span class="s">`json:&quot;departure_time&quot;`</span>
  <span class="n">Arrival_Time</span>    <span class="nb">int</span>       <span class="s">`json:&quot;arrival_time&quot;`</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// Подготвяне на маршрутите за връщане към клиента</span>
<span class="k">func</span> <span class="n">Encode</span><span class="p">(</span><span class="n">p</span> <span class="p">*</span><span class="n">Paths</span><span class="p">)</span> <span class="nb">string</span> <span class="p">{</span>
  <span class="c1">// Създаване и запълване нова експортна структура</span>
  <span class="n">js</span> <span class="p">:=</span> <span class="n">p</span><span class="p">.</span><span class="n">CreateJSONStack</span><span class="p">(</span><span class="n">razpisanie</span><span class="p">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">razpisanie</span><span class="p">.</span><span class="n">trains</span><span class="p">)</span>
  <span class="c1">// Преобразуване на структурата в JSON запис</span>
  <span class="n">b</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">json</span><span class="p">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="n">b</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;{&#39;err&#39;: &#39;Marshal Failure&#39;}&quot;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// Връщане на JSON текста</span>
  <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Създаване и запълване нова експортна структура</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="p">*</span><span class="n">Paths</span><span class="p">)</span> <span class="n">CreateJSONStack</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">trains</span> <span class="p">*</span><span class="n">Dictionary</span><span class="p">)</span> <span class="n">JSONStack</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">js</span> <span class="n">JSONStack</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">p</span><span class="p">.</span><span class="n">paths</span> <span class="p">{</span>
    <span class="c1">// Добавяне към експортната структура на всеки маршрут</span>
    <span class="n">js</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">js</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">DumpJSON</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">trains</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">js</span>
<span class="p">}</span>

<span class="c1">// Експорт на заглавна част на маршрута</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="p">*</span><span class="n">Stack</span><span class="p">)</span> <span class="n">DumpJSON</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">trains</span> <span class="p">*</span><span class="n">Dictionary</span><span class="p">)</span> <span class="n">JSONPath</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">jp</span> <span class="n">JSONPath</span>
  <span class="c1">// Начална гара</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">From_Station_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">stations</span><span class="p">)[(*</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">].</span><span class="n">id</span>
  <span class="c1">// Крайна гара</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">To_Station_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">stations</span><span class="p">)[(*</span><span class="n">s</span><span class="p">)[</span><span class="nb">len</span><span class="p">(*</span><span class="n">s</span><span class="p">)-</span><span class="mi">1</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">].</span><span class="n">id</span>
  <span class="c1">// Разстояние и брой прехвърляния</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">Distance</span><span class="p">,</span> <span class="n">jp</span><span class="p">.</span><span class="n">Transfers</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">GetDistanceAndTransfers</span><span class="p">()</span>
  <span class="c1">// Час на потегляне за маршрута</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">Departure_Time</span> <span class="p">=</span> <span class="p">(*</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">time</span>
  <span class="c1">// Час на пристигане за маршрута</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">Arrival_Time</span> <span class="p">=</span> <span class="p">(*</span><span class="n">s</span><span class="p">)[</span><span class="nb">len</span><span class="p">(*</span><span class="n">s</span><span class="p">)-</span><span class="mi">1</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">time</span>
  <span class="c1">// Експорт на сегментите на маршрута</span>
  <span class="n">jp</span><span class="p">.</span><span class="n">Details</span> <span class="p">=</span> <span class="p">(*</span><span class="n">s</span><span class="p">).</span><span class="n">DumpRouteDeatilsJSON</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">trains</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jp</span>
<span class="p">}</span>

<span class="c1">// Експорт на сегментите на маршрута</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="p">*</span><span class="n">Stack</span><span class="p">)</span> <span class="n">DumpRouteDeatilsJSON</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">trains</span> <span class="p">*</span><span class="n">Dictionary</span><span class="p">)</span> <span class="p">[]</span><span class="n">JSONDetail</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">jds</span> <span class="p">[]</span><span class="n">JSONDetail</span>
  <span class="k">var</span> <span class="n">jd</span> <span class="n">JSONDetail</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">Distance</span> <span class="p">=</span> <span class="mi">0</span>     <span class="c1">// Разстояние за сегмента</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">To_Station_Id</span> <span class="p">=</span> <span class="mi">0</span>  <span class="c1">// Крайна гара за сегмента</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">Arrival_Time</span> <span class="p">=</span> <span class="mi">0</span>   <span class="c1">// Час на пристигане за сегмента</span>
  <span class="c1">// Идентификатор на влак за сегмента</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">Train_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">trains</span><span class="p">)[(*</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">train</span><span class="p">].</span><span class="n">id</span>
  <span class="c1">// Начална гара за сегмента</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">From_Station_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">stations</span><span class="p">)[(*</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">].</span><span class="n">id</span>
  <span class="c1">// Час на потегляне за сегмента</span>
  <span class="n">jd</span><span class="p">.</span><span class="n">Departure_Time</span> <span class="p">=</span> <span class="p">(*</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">node</span><span class="p">.</span><span class="n">time</span>
  <span class="c1">// Обхождане на всички елементи на маршрута</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">path</span> <span class="p">:=</span> <span class="k">range</span> <span class="p">*</span><span class="n">s</span> <span class="p">{</span>
    <span class="c1">// Промяна на крайната гара</span>
    <span class="n">jd</span><span class="p">.</span><span class="n">To_Station_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">stations</span><span class="p">)[</span><span class="n">path</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">].</span><span class="n">id</span>
    <span class="c1">// Промяна на часа на пристигане</span>
    <span class="n">jd</span><span class="p">.</span><span class="n">Arrival_Time</span> <span class="p">=</span> <span class="n">path</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">time</span>
    <span class="c1">// Ако има следващ връх</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">.</span><span class="n">arc</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
      <span class="c1">// Добавяме разстоянието на дъгата към сегмента</span>
      <span class="n">jd</span><span class="p">.</span><span class="n">Distance</span> <span class="p">+=</span> <span class="n">path</span><span class="p">.</span><span class="n">arc</span><span class="p">.</span><span class="n">length</span>
      <span class="c1">// Ако дъгата е за прехвърляне</span>
      <span class="k">if</span> <span class="n">path</span><span class="p">.</span><span class="n">arc</span><span class="p">.</span><span class="n">atype</span> <span class="p">==</span> <span class="n">TRANSFER</span> <span class="p">{</span>
        <span class="c1">// Добавяме сегмента към резултата</span>
        <span class="n">jds</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">jds</span><span class="p">,</span> <span class="n">jd</span><span class="p">)</span>
        <span class="c1">// Инициализираме променливите за новия сегмент</span>
        <span class="n">jd</span><span class="p">.</span><span class="n">Distance</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="n">jd</span><span class="p">.</span><span class="n">Train_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">trains</span><span class="p">)[</span><span class="n">path</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">train</span><span class="p">].</span><span class="n">id</span>
        <span class="n">jd</span><span class="p">.</span><span class="n">From_Station_Id</span> <span class="p">=</span> <span class="p">(*</span><span class="n">stations</span><span class="p">)[</span><span class="n">path</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">].</span><span class="n">id</span>
        <span class="n">jd</span><span class="p">.</span><span class="n">Departure_Time</span> <span class="p">=</span> <span class="n">path</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">time</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Добавяме последния сегмент</span>
  <span class="n">jds</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">jds</span><span class="p">,</span> <span class="n">jd</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jds</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Използвайки така дефинирания граф, можем да приложим алгоритъм за обхождане в дълбочина с ограничаващи условия за да получим възможните маршрути. Самият алгоритъм по същността си е рекурсивно обхождане на дъгите на всяка точка до достигане на целта:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="p">*</span><span class="n">Paths</span><span class="p">)</span> <span class="n">FindWay</span><span class="p">(</span><span class="n">node</span> <span class="p">*</span><span class="n">DFSNode</span><span class="p">,</span> <span class="n">end_station</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">transfers</span><span class="p">,</span> <span class="n">max_transfers</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">station</span> <span class="p">==</span> <span class="n">end_station</span> <span class="p">{</span>
    <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">NewStackNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nil</span><span class="p">))</span>
    <span class="n">p</span><span class="p">.</span><span class="n">AddPath</span><span class="p">()</span>
    <span class="n">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">arc</span> <span class="p">:=</span> <span class="k">range</span> <span class="n">node</span><span class="p">.</span><span class="n">arcs</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">arc</span><span class="p">.</span><span class="n">next</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="c1">// Без прехвърляне на първа станция</span>
        <span class="k">if</span> <span class="n">length</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span> <span class="n">arc</span><span class="p">.</span><span class="n">atype</span> <span class="p">==</span> <span class="n">TRANSFER</span> <span class="p">{</span>
          <span class="k">continue</span>
        <span class="p">}</span>
        <span class="c1">// Избор на дъга само ако ни приближава към целта</span>
        <span class="n">now</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">floyd</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">end_station</span><span class="p">)</span>
        <span class="n">next</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">floyd</span><span class="p">.</span><span class="n">GetDistance</span><span class="p">(</span><span class="n">arc</span><span class="p">.</span><span class="n">next</span><span class="p">.</span><span class="n">station</span><span class="p">,</span> <span class="n">end_station</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">now</span> <span class="p">&gt;=</span> <span class="n">next</span> <span class="p">&amp;&amp;</span> <span class="n">arc</span><span class="p">.</span><span class="n">length</span><span class="p">+</span><span class="n">length</span> <span class="p">&lt;=</span> <span class="p">(*</span><span class="n">p</span><span class="p">).</span><span class="n">max_distance</span> <span class="p">&amp;&amp;</span> <span class="n">transfers</span> <span class="p">&lt;=</span> <span class="n">max_transfers</span> <span class="p">{</span>
          <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">NewStackNode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">arc</span><span class="p">))</span>
          <span class="n">add</span> <span class="p">:=</span> <span class="mi">0</span>
          <span class="k">if</span> <span class="n">arc</span><span class="p">.</span><span class="n">atype</span> <span class="p">==</span> <span class="n">TRANSFER</span> <span class="p">{</span>
            <span class="n">add</span> <span class="p">=</span> <span class="mi">1</span>
          <span class="p">}</span>
          <span class="n">p</span><span class="p">.</span><span class="n">FindWay</span><span class="p">(</span><span class="n">arc</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">end_station</span><span class="p">,</span> <span class="n">length</span><span class="p">+</span><span class="n">arc</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="n">transfers</span><span class="p">+</span><span class="n">add</span><span class="p">),</span> <span class="n">max_transfers</span><span class="p">)</span>
          <span class="n">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">stack</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>В класическата реализация на обхождането, пътят се пази във върховете но в случая използваме стек за да постигнем многонишкова работа с данните, т.е. да можем да обработим няколко конкурентни заявки едновременно.</p></div>
<div class="paragraph"><p>Модулът работи като API сървър, отворен за заявки от потребителската част на сайта. Цялостния модел на работа на модула е представен на фигура 7:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/web_server.svg" alt="Обща схема на модул разписание" width="640">
</div>
<div class="title">Фигура 7. Обща схема на работа на модул razpisanie</div>
</div>
<div class="paragraph"><p>Модулът е реализиран на езикът Go (<a href="http://golang.org">http://golang.org</a>).</p></div>
</div>
<div class="sect2">
<h3 id="chapter-2-4">Потребителски модул</h3>
<div class="paragraph"><p>Потребителският модул на системата е предназначен за крайните клиенти на превозната услуга. За създаването му са използвани следните технологии:</p></div>
<div class="ulist"><ul>
<li>
<p>
PHP (<a href="http://php.net/">http://php.net/</a>)- език за програмиране;
</p>
</li>
<li>
<p>
CodeIgniter (<a href="http://codeigniter.com/">http://codeigniter.com/</a>)- framework;
</p>
</li>
<li>
<p>
Apache2 (<a href="http://httpd.apache.org/">http://httpd.apache.org/</a>) - уеб сървър;
</p>
</li>
<li>
<p>
Twitter Bootstrap (<a href="http://twitter.github.com/bootstrap/">http://twitter.github.com/bootstrap/</a>) - CSS/JavaScript библиотека поддържаща адаптивна структура;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Модулът позволява на потребителя следните възможности:</p></div>
<div class="ulist"><ul>
<li>
<p>
Търсене на маршрути между всяка двойка гари/спирки от разписанието за определена дата (Приложение: фиг. 1);
</p>
</li>
<li>
<p>
Избор на подходящ маршрут от списък (Приложение: фиг. 2);
</p>
</li>
<li>
<p>
Преглед на гарите/спирките, през които преминава превозното средство (Приложение: фиг. 8);
</p>
</li>
<li>
<p>
Преглед на превозните средства, които преминават през дадена гара/спирка (Приложение: фиг. 9);
</p>
</li>
<li>
<p>
Резервация на различни видове билети и избор на запазено място в превозното средство, където това е възможно (Приложение: фиг. 3);
</p>
</li>
<li>
<p>
Възможност за заплащане на резервираните билети онлайн (Приложение: фиг. 7).
</p>
</li>
<li>
<p>
Възможност за регистрация в портала от където да се следят всички закупени от клиента билети (Приложение: фиг. 5, фиг. 6);
</p>
</li>
</ul></div>
<div class="paragraph"><p>Основният процес на монетизация на сайта е чрез закупуването на превозни документи. Това се осъществява чрез следния процес:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/purchase_ticket_flowchart.svg" alt="Закупуване на билет" width="640">
</div>
<div class="title">Фигура 8. Процес на избор и закупуване на електронен билет за пътуване</div>
</div>
</div>
<div class="sect2">
<h3 id="chapter-2-5">Административен модул</h3>
<div class="paragraph"><p>Административният модул дава възможност за манипулация на следните елементи:</p></div>
<div class="sect3">
<h4 id="chapter-2-5-1">Гари/спирки</h4>
<div class="paragraph"><p>Всяка гара или спирка в системата се представя от име и географски координати (Приложение: фиг. 10 и фиг. 11). Координатите се използват при показване на информация за гара както и за маршрутите на влаковете.</p></div>
</div>
<div class="sect3">
<h4 id="__27">Влакове</h4>
<div class="paragraph"><p>Администрацията позволява въвеждането на нови влакове, както и редакцията на вече съществуващи (Приложение: фиг. 12, фиг. 13). Всеки влак се характеризира с име и тип.</p></div>
</div>
<div class="sect3">
<h4 id="___">Маршрути на влакове</h4>
<div class="paragraph"><p>Маршрутът на всеки влак се състои от поредица от име на гара, час на пристигане, час на заминаване и разстояние от началото на маршрута. Маршрутите могат да бъдат допълвани и променяни. (Приложение: фиг. 15)</p></div>
</div>
<div class="sect3">
<h4 id="_____2">Подвижен състав на влак</h4>
</div>
</div>
<div class="sect2">
<h3 id="chapter-2-5">Административен модул</h3>
<div class="paragraph"><p>Позволява указване на състава на влака. Тази информация се използва при продажбата на билети (Приложение: фиг. 14).</p></div>
<div class="sect3">
<h4 id="___5">Превозни средства</h4>
<div class="paragraph"><p>Тази администрация позволява добавяне и редактиране на елементите на подвижния състав. Всяко превозно средство се описва с код, име, брой места за пътници и схема, която се показва при избора на запазени места (Приложение: фиг. 18).</p></div>
<div class="paragraph"><p>Синтаксиса за дефиниране на схемата на превозното средство е:</p></div>
<div class="ulist"><ul>
<li>
<p>
" " - коридор;
</p>
</li>
<li>
<p>
"–" или "|" - стена;
</p>
</li>
<li>
<p>
"1" или "2" - съответен клас място;
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="__28">Тарифи</h4>
<div class="paragraph"><p>Позволява редакция на тарифните коефициенти за превоз. (Приложение: фиг. 17)</p></div>
<div class="paragraph"><p>Освен промяната на данни, администрацията дава достъп до няколко основни статистически справки:</p></div>
<div class="ulist"><ul>
<li>
<p>
Минимално разстояние между две гари (получава се от матрицата на теглата на модул <strong>razpisanie</strong>) (Приложение: фиг. 19);
</p>
</li>
<li>
<p>
Натоварване на гари (Приложение: фиг. 20);
</p>
</li>
<li>
<p>
Участъкова скорост по отсечки за влак (Приложение: фиг. 16);
</p>
</li>
<li>
<p>
Месечни приходи за влак;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Възможно е добавянето на допълнителни справки при необходимост.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-3">Ефективност на системата</h2>
<div class="sectionbody">
<div class="paragraph"><p>Така изготвената примерна система позволява бързо и лесно закупуване на желаните билети от потребителя. За проверка на ефективността на търсене на маршрути от модула <strong>razpisanie</strong> използваме следния скрипт:</p></div>
<div class="listingblock">
<div class="title">benchmark.php</div>
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">test</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:8080/route&#39;</span><span class="p">;</span>

  <span class="nv">$post</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;from=%d&amp;to=%d&#39;</span><span class="p">,</span> <span class="nv">$from</span><span class="p">,</span> <span class="nv">$to</span><span class="p">);</span>

  <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>

  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span><span class="nx">CURLOPT_URL</span><span class="p">,</span><span class="nv">$url</span><span class="p">);</span>
  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span><span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span><span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span><span class="nv">$post</span><span class="p">);</span>
  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span><span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
  <span class="nv">$result</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
  <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$from</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">700</span><span class="p">);</span>
  <span class="nv">$to</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">700</span><span class="p">);</span>
  <span class="nv">$time_start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
  <span class="nx">test</span><span class="p">(</span><span class="nv">$from</span><span class="p">,</span><span class="nv">$to</span><span class="p">);</span>
  <span class="k">echo</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$time_start</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div></div></div>
<div class="paragraph"><p>Скриптът извършва 1000 търсения на маршрути между две произволни гари. Резултатите от теста се виждат на фигура 9:</p></div>
<div class="imageblock">
<div class="content">
<img src="images/benchmark.svg" alt="Време за търсене на маршрути между произволни гари" width="640">
</div>
<div class="title">Фигура 9. Време за търсене на маршрути между произволни гари</div>
</div>
<div class="paragraph"><p>Средното време за търсене е 1.4 милисекунди като в това време се включва и времето за HTTP комуникация.</p></div>
<div class="paragraph"><p>По отношение на първоначалното стартиране на сървъра, времето от стартиране до пълна оперативна готовност е 4 секунди:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>2012/07/03 14:41:28 Loaded 12552 lines from "data/paths.txt"
2012/07/03 14:41:32 Server operational</pre>
</div></div>
<div class="paragraph"><p>Тестовете са проведени на конфигурация:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
Процесор
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
  Intel&#174; Core&#8482; i3 CPU 3.20GHz
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Памет
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
  8 GB
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Операционна система
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
  Debian Wheezy
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Ядро
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
  linux-image-3.2.0-2-686-pae #1 SMP Mon Jun 11 18:27:04 UTC 2012 i686 GNU/Linux
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Компилатор
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
  go1.0.1
</p>
</td>
</tr>
</table></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Изводи и препоръки</h2>
<div class="sectionbody">
<div class="paragraph"><p>Так описаната система подлежи на развитие постоянно развитие и модификация. Едно допълнително приложение на системата би могло да бъде интегрирането и в т.нар. киоск системи. Примерна конфигурация на такава система би могла да бъде окомплектована с АТМ функционалност както и с фискален принтер за директен печат на билети.</p></div>
<div class="paragraph"><p>Друго направление за употреба на системата би могло да бъде интегрирането и със сродни системи за други видове транспорт. Това ще добави още по голяма стойност към услугата. Възвращаемостта от подобна система може да надхвърли в пъти инвестицията направена за изработка или закупуване на подобна система. Оперативните разходи по системата са минимални и голяма част от тях се правят и при сега наличия портал.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/hetero_system.svg" alt="Принципна схема на интегрирана система за предоставяне на транспортни услуги" width="640">
</div>
<div class="title">Фигура 10. Принципна схема на интегрирана система за предоставяне на транспортни услуги</div>
</div>
<div class="paragraph"><p>Една такава децентрализирана система би комуникирала с отделните системи на доставчиците на транспортни услуги чрез унифициран програмен интерфейс (API), който минимално би трябвало да включва команди за:</p></div>
<div class="ulist"><ul>
<li>
<p>
маршрути между две точки за интервал от време;
</p>
</li>
<li>
<p>
свободни позиции за маршрут;
</p>
</li>
<li>
<p>
възможност за резервация на позиция;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Ползите от подобни системи са:</p></div>
<div class="ulist"><ul>
<li>
<p>
удобство и предсказуемост за клиентите;
</p>
</li>
<li>
<p>
унификация на критериите;
</p>
</li>
<li>
<p>
по-добри условия за конкуренция;
</p>
</li>
<li>
<p>
по-лесно "продаване" на транспортната услуга;
</p>
</li>
<li>
<p>
възможности за оптимизация и планиране;
</p>
</li>
</ul></div>
<div class="paragraph"><p>Информационни системи се използват в транспорта и днес. Това което се забравя обикновено е че една информационна система никога не е завършена, защото тя трябва да отразява реалния свят, който винаги се променя.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="___6">Използвана литература</h2>
<div class="sectionbody">
<div class="paragraph"><p>Списък с използваната литература</p></div>
<div class="ulist bibliography"><div class="title">Книги</div><ul>
<li>
<p>
<a id="nakov"></a>[nakov] Наков, Преслав, Основи на компютърните алгоритми, Top Team Co., 1999
</p>
</li>
</ul></div>
<div class="ulist bibliography"><div class="title">Публикации</div><ul>
<li>
<p>
<a id="dnevnik"></a>[dnevnik] Катанска, Ц. <em>БДЖ разработи е-система за поръчка на билети, но без да спестява опашките</em>, Дневник, <a href="http://www.dnevnik.bg/bulgaria/2010/06/22/921090_bdj_razraboti_e-sistema_za_poruchka_na_bileti_no_bez/">http://www.dnevnik.bg/bulgaria/2010/06/22/921090_bdj_razraboti_e-sistema_za_poruchka_na_bileti_no_bez/</a>
</p>
</li>
<li>
<p>
<a id="eurostat"></a>[eurostat] EU Transport in figures 2011, <a href="http://ec.europa.eu/transport/publications/statistics/doc/2011/pocketbook2011.pdf">http://ec.europa.eu/transport/publications/statistics/doc/2011/pocketbook2011.pdf</a>
</p>
</li>
<li>
<p>
<a id="nsi"></a>[nsi] Национален статистически институт - 2.1.2.2. Превозени пътници и извършена работа, <a href="http://www.nsi.bg/otrasal.php?otr=6&amp;a1=858&amp;a2=859&amp;a3=892&amp;a4=894">http://www.nsi.bg/otrasal.php?otr=6&amp;a1=858&amp;a2=859&amp;a3=892&amp;a4=894</a>
</p>
</li>
<li>
<p>
<a id="hgise"></a>[hgise] Maps of European railways, Historical GIS of Europe, <a href="http://www.europa.udl.cat/contents/transport-infrastructures/railways/europe/maps">http://www.europa.udl.cat/contents/transport-infrastructures/railways/europe/maps</a>
</p>
</li>
<li>
<p>
<a id="cozac"></a>[cozac] Cozac Ion, <em>DRUMURI OPTIME ÎN GRAFURI ORAR</em>, <a href="http://www.upm.ro/facultati_departamente/stiinte_litere/conferinte/situl_integrare_europeana/Lucrari2/Ioan%20Cozac.pdf">http://www.upm.ro/facultati_departamente/stiinte_litere/conferinte/situl_integrare_europeana/Lucrari2/Ioan%20Cozac.pdf</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Версия 0.1<br>
Последно обновяване 2012-07-19 09:26:32 EEST
</div>
</div>
</body>
</html>
